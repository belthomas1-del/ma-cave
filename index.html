<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#0C0A08">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<title>Ma Cave</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Source+Sans+3:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Source Sans 3',system-ui,sans-serif;background:#0C0A08;color:#E8E0D4;font-size:15px;line-height:1.5}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(180,140,80,0.15);border-radius:4px}
h1,h2,h3,.serif{font-family:'Playfair Display',Georgia,serif}
input,select,textarea{font-family:inherit;font-size:15px;outline:none}
button{font-family:inherit;cursor:pointer;border:none;background:none}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(60px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 0 0 rgba(200,168,85,0)}50%{box-shadow:0 0 0 6px rgba(200,168,85,0.25)}}
@keyframes bottlePlace{from{opacity:0;transform:scale(0.5) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
</style>
</head>
<body>
<div id="root"></div>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{})</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const{useState,useEffect,useMemo,useCallback,useRef}=React;

const P={
  bg:"#0C0A08",bg1:"#13110E",bg2:"#1A1714",bg3:"#242018",bg4:"#302A20",
  card:"rgba(255,245,230,0.025)",cardH:"rgba(255,245,230,0.05)",cardB:"rgba(255,245,230,0.06)",
  ink:"#EDE5D8",ink2:"#BDB5A4",ink3:"#8A8272",ink4:"#585040",
  gold:"#C9A84C",goldDim:"rgba(201,168,76,0.12)",goldGlow:"rgba(201,168,76,0.06)",
  wine:"#7B2038",wineLt:"rgba(123,32,56,0.15)",
  ok:"#6DAF6D",okBg:"rgba(109,175,109,0.1)",
  danger:"#D46A6A",dangerBg:"rgba(212,106,106,0.1)",
  glass:"rgba(255,250,240,0.03)",glassBd:"rgba(255,250,240,0.06)",
};

const TP={
  rouge:{l:"Rouge",ic:"üç∑",c:"#9B2335",bg:"rgba(155,35,53,0.12)",grad:"linear-gradient(180deg,#5A0F1E,#8B1A30,#6A1525)",capC:"#6B0F1E"},
  blanc:{l:"Blanc",ic:"ü•Ç",c:"#C5A830",bg:"rgba(197,168,48,0.12)",grad:"linear-gradient(180deg,#7A6A10,#B8A020,#8B7A18)",capC:"#7A6A10"},
  rose:{l:"Ros√©",ic:"üå∏",c:"#D4789A",bg:"rgba(212,120,154,0.12)",grad:"linear-gradient(180deg,#8A4060,#C06888,#A05878)",capC:"#8A4060"},
  petillant:{l:"P√©tillant",ic:"‚ú®",c:"#D4B855",bg:"rgba(212,184,85,0.12)",grad:"linear-gradient(180deg,#8A8020,#C8B040,#A89830)",capC:"#8A8020"},
};

const RC={rouge:{"Bordeaux":"#5A1020","Bourgogne":"#7A1838","Rh√¥ne":"#6A1818","Loire":"#8A3838","Languedoc":"#6E2525","Beaujolais":"#A02848","Provence":"#7A3535","Sud-Ouest":"#7A3232","Italie":"#6B2020","Espagne":"#8A2020","Autre":"#5A2222"},
  blanc:{"Alsace":"#B8860B","Bourgogne":"#A07A10","Loire":"#8B7020","Bordeaux":"#957A15","Champagne":"#AA8A05","Jura":"#887020","Autre":"#907818"},
  rose:{"Provence":"#C06080","Loire":"#B87088","Languedoc":"#B06878","Autre":"#A86878"},
  petillant:{"Champagne":"#D4AF37","Cr√©mant d'Alsace":"#C0A030","Prosecco":"#C8A830","Autre":"#B8A030"}};

function wineColor(b){return b?(RC[b.type]||{})[b.region]||TP[b.type]?.c||"#9B2335":null}
function classify(id){return{1:"rouge",2:"blanc",3:"petillant",4:"rose",7:"rose"}[id]||"rouge"}
function mapReg(n){if(!n)return"Autre";const r=n.toLowerCase();const m={"bordeaux":"Bordeaux","bourgogne":"Bourgogne","burgundy":"Bourgogne","rh√¥ne":"Rh√¥ne","rhone":"Rh√¥ne","loire":"Loire","alsace":"Alsace","champagne":"Champagne","languedoc":"Languedoc","roussillon":"Languedoc","provence":"Provence","beaujolais":"Beaujolais","sud-ouest":"Sud-Ouest","jura":"Jura","toscana":"Italie","tuscany":"Italie","piemonte":"Italie","veneto":"Italie","rioja":"Espagne","ribera":"Espagne","priorat":"Espagne"};for(const[k,v]of Object.entries(m))if(r.includes(k))return v;return n.length>2?n:"Autre"}

const SK="cave-v8",load=()=>{try{return JSON.parse(localStorage.getItem(SK))||{}}catch{return{}}},save=d=>{try{localStorage.setItem(SK,JSON.stringify(d))}catch{}};

function parseBE(r){return{name:r.name,winery:r.winery||"",vintage:r.vintage||null,type:classify(r.type_id),region:mapReg(r.region),region_raw:r.region||"",rating:r.rating,ratings_count:r.ratings_count||null,price:r.price,image:r.image||null,grape:r.grape||null,description:r.description||null,food:r.food||null,body_desc:r.body_desc||null,acidity_desc:r.acidity_desc||null,vivino_url:r.vivino_url||(r.seo_name?("https://www.vivino.com/"+r.seo_name):null),notes:null,apogee_start:null,apogee_end:null}}

async function doSearch(q,url,onLog){
  const log=onLog||(()=>{});
  if(!url){log("‚ö†Ô∏è Configurez le serveur dans R√©glages");return null}
  log("‚òÅÔ∏è Recherche...");
  try{
    const c=new AbortController,t=setTimeout(()=>c.abort(),25000);
    const r=await fetch(url+"/search?q="+encodeURIComponent(q),{signal:c.signal});
    clearTimeout(t);
    if(r.ok){const d=await r.json();if(d.results?.length){log("‚úÖ "+d.results.length+" r√©sultat"+(d.results.length>1?"s":""));return{results:d.results.map(parseBE),source:d.source||"api"}}}
    else{const err=await r.json().catch(()=>({}));log("‚ùå "+(err.error||"Erreur "+r.status))}
  }catch(e){log("‚ùå "+(e.name==="AbortError"?"Timeout ‚Äî r√©essayez":e.message))}
  return null}

function App(){
  const sv=load();
  const[bottles,setBottles]=useState(sv.bottles||{});
  const[config,setConfig]=useState({cols:10,rows:6,backendUrl:"https://ma-cave-api.bellon-thomas1.workers.dev",view:"rack",...(sv.config||{})});
  const[tab,setTab]=useState("cave");
  const[modal,setModal]=useState(null);
  const[query,setQuery]=useState("");
  const[results,setResults]=useState([]);
  const[searching,setSearching]=useState(false);
  const[dbgLog,setDbgLog]=useState([]);
  const[addMode,setAddMode]=useState("vivino");
  const[form,setForm]=useState(ef());
  const[eCfg,setECfg]=useState(config);
  const[toast,setToast]=useState(null);
  const[fType,setFType]=useState(null);
  const[fReg,setFReg]=useState(null);
  const[fQ,setFQ]=useState("");
  const[fApo,setFApo]=useState(false);
  const[showF,setShowF]=useState(false);
  const[moveMode,setMoveMode]=useState(null);
  const[editMode,setEditMode]=useState(false);
  const mainRef=useRef(null);

  useEffect(()=>{save({bottles,config})},[bottles,config]);
  function ef(){return{name:"",winery:"",vintage:"",type:"rouge",region:"Bordeaux",notes:"",image:"",apogee_start:"",apogee_end:"",rating:"",price:"",grape:"",description:"",food:"",vivino_url:"",region_raw:""}}
  const flash=m=>{setToast(m);setTimeout(()=>setToast(null),2200)};
  const ck=(c,r)=>c+"-"+r;
  const closeM=()=>{setModal(null);setQuery("");setResults([]);setAddMode("vivino");setForm(ef());setDbgLog([]);setEditMode(false)};

  const runS=async()=>{if(!query.trim())return;setSearching(true);setResults([]);const logs=[];
    const r=await doSearch(query.trim(),config.backendUrl,m=>{logs.push(m);setDbgLog([...logs])});
    if(r)setResults(r.results);setSearching(false)};

  const prefillFromVivino=(w)=>{
    setForm({name:w.name||"",winery:w.winery||"",vintage:w.vintage?String(w.vintage):"",type:w.type||"rouge",
      region:w.region||"Autre",notes:"",image:w.image||"",apogee_start:"",apogee_end:"",
      rating:w.rating?String(w.rating):"",price:w.price||"",grape:w.grape||"",description:w.description||"",
      food:w.food||"",vivino_url:w.vivino_url||"",region_raw:w.region_raw||""});
    setAddMode("edit");
  };

  const formToBottle=(f)=>({
    name:f.name,winery:f.winery||"",vintage:f.vintage?Number(f.vintage):null,
    type:f.type,region:f.region||"Autre",region_raw:f.region_raw||f.region||"",
    image:f.image||null,notes:f.notes||null,
    rating:f.rating?Number(f.rating):null,price:f.price||null,
    grape:f.grape||null,description:f.description||null,
    food:f.food||null,vivino_url:f.vivino_url||null,
    apogee_start:f.apogee_start?Number(f.apogee_start):null,
    apogee_end:f.apogee_end?Number(f.apogee_end):null,
  });

  const addB=(key,data)=>{setBottles(p=>({...p,[key]:{...data,added:new Date().toISOString()}}));flash("‚úì Ajout√©");closeM()};
  const updateB=(key,data)=>{setBottles(p=>({...p,[key]:{...p[key],...data}}));flash("‚úì Modifi√©");setEditMode(false)};
  const rmB=key=>{setBottles(p=>{const n={...p};delete n[key];return n});flash("Retir√©");closeM()};
  const moveB=(fromKey,toKey)=>{setBottles(p=>{const n={...p};n[toKey]=n[fromKey];delete n[fromKey];return n});setMoveMode(null);flash("‚úì D√©plac√©")};
  const firstEmpty=()=>{for(let r=0;r<config.rows;r++)for(let c=0;c<config.cols;c++){const k=ck(c,r);if(!bottles[k])return k}return null};

  const allB=Object.values(bottles);
  const cap=config.cols*config.rows;
  const yr=new Date().getFullYear();
  const regs=useMemo(()=>[...new Set(allB.map(b=>b.region))].sort(),[bottles]);
  const fRegs=useMemo(()=>[...new Set([...Object.keys(RC[form.type]||{}),...regs])].sort(),[form.type,regs]);

  const stats=useMemo(()=>{const s={total:0,types:{},regions:{},ratings:[],prices:[]};
    allB.forEach(b=>{s.total++;s.types[b.type]=(s.types[b.type]||0)+1;s.regions[b.region]=(s.regions[b.region]||0)+1;
      if(b.rating)s.ratings.push(b.rating);if(b.price){const n=parseFloat(b.price);if(!isNaN(n))s.prices.push(n)}});
    s.avgR=s.ratings.length?(s.ratings.reduce((a,c)=>a+c,0)/s.ratings.length).toFixed(1):null;
    s.totV=s.prices.length?s.prices.reduce((a,c)=>a+c,0):null;return s},[bottles]);

  const isF=fType||fReg||fQ||fApo;
  const mF=b=>{if(!b)return false;if(fType&&b.type!==fType)return false;if(fReg&&b.region!==fReg)return false;
    if(fQ){const q=fQ.toLowerCase();if(!b.name.toLowerCase().includes(q)&&!(b.winery||"").toLowerCase().includes(q)&&!(b.vintage+"").includes(q))return false}
    if(fApo){if(!b.apogee_start&&!b.apogee_end)return false;if(yr<(b.apogee_start||0)||yr>(b.apogee_end||9999))return false}return true};

  const is={background:"rgba(255,245,230,0.04)",border:"1px solid rgba(255,245,230,0.08)",color:P.ink,padding:"12px 16px",borderRadius:12,width:"100%",fontSize:15,transition:"border 0.2s"};
  const CW=52,CH=50;

  return(
  <div style={{height:"100dvh",display:"flex",flexDirection:"column",background:P.bg,position:"relative",overflow:"hidden"}}>
    <div style={{position:"fixed",top:"-30%",left:"-10%",width:"50%",height:"50%",background:"radial-gradient(circle,rgba(180,120,40,0.04) 0%,transparent 70%)",pointerEvents:"none",zIndex:0}}/>
    <div style={{position:"fixed",bottom:"-20%",right:"-15%",width:"45%",height:"45%",background:"radial-gradient(circle,rgba(120,30,50,0.04) 0%,transparent 70%)",pointerEvents:"none",zIndex:0}}/>

    {/* HEADER */}
    <header style={{padding:"20px 20px 14px",position:"relative",zIndex:2,flexShrink:0}}>
      <div style={{display:"flex",alignItems:"flex-end",justifyContent:"space-between"}}>
        <div>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <h1 className="serif" style={{fontSize:30,color:P.ink,fontWeight:400,letterSpacing:-0.5,lineHeight:1}}>Ma Cave</h1>
            <div style={{height:20,width:1,background:P.ink4}}/>
            <span style={{fontSize:12,color:P.ink3,fontWeight:400,letterSpacing:1,textTransform:"uppercase"}}>{stats.total} bouteille{stats.total!==1?"s":""}</span>
          </div>
          {stats.total>0&&<div style={{marginTop:8,display:"flex",alignItems:"center",gap:8}}>
            <div style={{flex:1,maxWidth:120,height:3,background:P.bg3,borderRadius:2,overflow:"hidden"}}>
              <div style={{height:"100%",width:Math.min(100,Math.round(stats.total/cap*100))+"%",background:`linear-gradient(90deg,${P.wine},${P.gold})`,borderRadius:2,transition:"width 0.6s"}}/>
            </div>
            <span style={{fontSize:11,color:P.ink4}}>{Math.round(stats.total/cap*100)}%</span>
          </div>}
        </div>
        {tab==="cave"&&<div style={{display:"flex",gap:6}}>
          {moveMode&&<button onClick={()=>setMoveMode(null)} style={{padding:"6px 14px",borderRadius:10,fontSize:12,fontWeight:600,background:P.dangerBg,color:P.danger,border:"1px solid rgba(212,106,106,0.2)"}}>‚úï Annuler</button>}
          <Btn ic={config.view==="list"?"‚äû":"‚ò∞"} ck={()=>setConfig(c=>({...c,view:c.view==="list"?"rack":"list"}))}/>
          <Btn ic={isF?"‚ö°":"‚åï"} on={showF||isF} ck={()=>setShowF(f=>!f)}/>
        </div>}
      </div>
      {moveMode&&<div style={{marginTop:10,padding:"8px 14px",borderRadius:10,background:"rgba(201,168,76,0.1)",border:"1px solid rgba(201,168,76,0.2)",fontSize:13,color:P.gold,animation:"fadeIn 0.2s"}}>
        üì¶ Tapez une case vide pour d√©placer <strong>{bottles[moveMode]?.name?.substring(0,25)}</strong>
      </div>}
    </header>

    {/* FILTERS */}
    {showF&&tab==="cave"&&<div style={{padding:"0 20px 14px",flexShrink:0,animation:"slideDown 0.15s",zIndex:2,position:"relative"}}>
      <div style={{background:P.glass,backdropFilter:"blur(40px)",border:"1px solid "+P.glassBd,borderRadius:16,padding:14}}>
        <input value={fQ} onChange={e=>setFQ(e.target.value)} placeholder="Rechercher un vin..." style={{...is,marginBottom:10,background:"rgba(255,245,230,0.03)",padding:"10px 14px",fontSize:14}}/>
        <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}}>
          {Object.entries(TP).map(([k,v])=><Tag key={k} on={fType===k} ck={()=>setFType(f=>f===k?null:k)} c={v.c}>{v.ic} {v.l}{stats.types[k]?" ¬∑ "+stats.types[k]:""}</Tag>)}
        </div>
        {regs.length>0&&<div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}}>
          {regs.map(r=><Tag key={r} on={fReg===r} ck={()=>setFReg(f=>f===r?null:r)}>{r}</Tag>)}
        </div>}
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <Tag on={fApo} ck={()=>setFApo(f=>!f)} c={P.ok}>üéØ Apog√©e {yr}</Tag>
          {isF&&<button onClick={()=>{setFType(null);setFReg(null);setFQ("");setFApo(false)}} style={{fontSize:12,color:P.ink4,textDecoration:"underline"}}>Tout effacer</button>}
        </div>
      </div>
    </div>}

    {/* MAIN */}
    <main ref={mainRef} style={{flex:1,overflowY:"auto",overflowX:"hidden",position:"relative",zIndex:1}}>

      {tab==="cave"&&<div style={{padding:"0 20px 100px"}}>
        {firstEmpty()&&!moveMode&&<button onClick={()=>{setForm(ef());setAddMode("vivino");setModal({type:"add",cell:firstEmpty()})}}
          style={{width:"100%",padding:16,borderRadius:16,fontSize:15,fontWeight:600,marginBottom:16,
            background:`linear-gradient(135deg,${P.wine} 0%,#4A0A18 100%)`,color:"#F0D8DC",
            boxShadow:"0 4px 24px rgba(123,32,56,0.3),inset 0 1px 0 rgba(255,255,255,0.08)",
            display:"flex",alignItems:"center",justifyContent:"center",gap:10,
            border:"1px solid rgba(255,200,200,0.08)"}}>
          <span style={{fontSize:22,fontWeight:300}}>+</span> Ajouter une bouteille
        </button>}

        {allB.length===0&&<div style={{textAlign:"center",padding:"80px 20px",animation:"fadeIn 0.4s"}}>
          <div style={{fontSize:72,marginBottom:20,animation:"float 4s ease-in-out infinite",filter:"drop-shadow(0 8px 20px rgba(123,32,56,0.2))"}}>üç∑</div>
          <div className="serif" style={{fontSize:24,color:P.ink,marginBottom:8}}>Votre cave est vide</div>
          <div style={{fontSize:14,color:P.ink3,maxWidth:260,margin:"0 auto",lineHeight:1.6}}>Commencez par ajouter votre premi√®re bouteille</div>
        </div>}

        {/* LIST VIEW */}
        {config.view==="list"&&Object.entries(bottles).filter(([k,b])=>!isF||mF(b)).map(([key,b],i)=>{
          const tc=TP[b.type]||TP.rouge,color=wineColor(b);
          const atApo=b.apogee_start&&b.apogee_end&&yr>=b.apogee_start&&yr<=b.apogee_end;
          return(
            <div key={key} onClick={()=>{if(moveMode){if(moveMode!==key&&!bottles[key])moveB(moveMode,key);return}setModal({type:"detail",cell:key})}}
              style={{display:"flex",gap:14,padding:14,borderRadius:18,marginBottom:10,cursor:"pointer",
                background:moveMode===key?"rgba(201,168,76,0.08)":P.card,
                border:"1px solid "+(moveMode===key?"rgba(201,168,76,0.2)":P.cardB),
                animation:`fadeIn 0.3s ${i*0.04}s both`,
                position:"relative",overflow:"hidden",transition:"all 0.2s"}}>
              <div style={{position:"absolute",left:0,top:8,bottom:8,width:3,borderRadius:2,background:color}}/>
              <div style={{width:52,height:76,borderRadius:12,flexShrink:0,overflow:"hidden",marginLeft:6,
                background:b.image?P.bg2:tc.grad,display:"flex",alignItems:"center",justifyContent:"center",
                boxShadow:"0 4px 12px rgba(0,0,0,0.2)"}}>
                {b.image?<img src={b.image} alt="" style={{width:"100%",height:"100%",objectFit:"contain"}} onError={e=>{e.target.style.display="none";e.target.parentElement.style.background=tc.grad}}/>
                  :<span style={{fontSize:24,opacity:0.6}}>{tc.ic}</span>}
              </div>
              <div style={{flex:1,minWidth:0,display:"flex",flexDirection:"column",justifyContent:"center",gap:3}}>
                <div style={{fontSize:15,fontWeight:600,color:P.ink,lineHeight:1.3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.name}</div>
                {b.winery&&<div style={{fontSize:12,color:P.ink3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.winery}</div>}
                <div style={{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap",fontSize:12,marginTop:2}}>
                  {b.vintage&&<span style={{color:P.gold,fontWeight:600,fontFamily:"'Playfair Display',serif"}}>{b.vintage}</span>}
                  <span style={{color:P.ink4}}>¬∑</span>
                  <span style={{color:P.ink3}}>{b.region}</span>
                  <span style={{background:tc.bg,color:tc.c,padding:"2px 8px",borderRadius:8,fontSize:10,fontWeight:600}}>{tc.l.toUpperCase()}</span>
                  {atApo&&<span style={{background:P.okBg,color:P.ok,padding:"2px 8px",borderRadius:8,fontSize:10,fontWeight:600}}>APOG√âE</span>}
                </div>
                {(b.rating||b.price)&&<div style={{display:"flex",gap:10,marginTop:2,fontSize:12}}>
                  {b.rating&&<span style={{color:P.gold}}>‚òÖ {b.rating}</span>}
                  {b.price&&<span style={{color:P.ink4}}>{b.price}</span>}
                </div>}
              </div>
              <div style={{fontSize:10,color:P.ink4,fontWeight:500,alignSelf:"flex-start",fontFamily:"monospace"}}>{parseInt(key.split("-")[0])+1}{String.fromCharCode(65+parseInt(key.split("-")[1]))}</div>
            </div>
          )})}

        {/* RACK VIEW */}
        {config.view==="rack"&&<div style={{marginTop:4}}>
          <div style={{
            background:`linear-gradient(180deg,#4A3620 0%,#3A2815 8%,#2E1E0E 50%,#3A2815 92%,#4A3620 100%)`,
            borderRadius:14,padding:"10px 8px 4px",
            boxShadow:"0 10px 40px rgba(0,0,0,0.5),inset 0 2px 0 rgba(200,160,100,0.1),inset 0 -2px 0 rgba(0,0,0,0.3)",
            overflowX:"auto",position:"relative",border:"1px solid rgba(120,80,40,0.2)",
          }}>
            <div style={{position:"absolute",inset:0,borderRadius:14,opacity:0.05,
              backgroundImage:"repeating-linear-gradient(90deg,transparent 0px,transparent 3px,rgba(255,200,100,0.4) 3px,rgba(255,200,100,0.4) 4px,transparent 4px,transparent 22px)",
              pointerEvents:"none"}}/>

            <div style={{display:"flex",paddingLeft:26,marginBottom:4}}>
              {Array.from({length:config.cols},(_,c)=>
                <div key={c} style={{width:CW,minWidth:CW,textAlign:"center",fontSize:9,color:"rgba(200,160,100,0.3)",fontWeight:700,fontFamily:"monospace"}}>{c+1}</div>
              )}
            </div>

            {Array.from({length:config.rows},(_,r)=>
              <div key={r}>
                <div style={{display:"flex",alignItems:"center"}}>
                  <div style={{width:24,textAlign:"center",fontSize:9,color:"rgba(200,160,100,0.3)",fontWeight:700,flexShrink:0,fontFamily:"monospace"}}>{String.fromCharCode(65+r)}</div>
                  {Array.from({length:config.cols},(_,c)=>{
                    const key=ck(c,r),b=bottles[key],color=wineColor(b);
                    const dim=isF&&b&&!mF(b);
                    const isMoveSrc=moveMode===key;
                    const isMoveTarget=moveMode&&!b&&moveMode!==key;
                    const tc=b?TP[b.type]||TP.rouge:null;
                    return<div key={key}
                      onClick={()=>{
                        if(moveMode){if(!b&&moveMode!==key)moveB(moveMode,key);else if(moveMode===key)setMoveMode(null);return}
                        if(b)setModal({type:"detail",cell:key});
                        else{setForm(ef());setAddMode("vivino");setModal({type:"add",cell:key})}
                      }}
                      style={{
                        width:CW,height:CH,minWidth:CW,cursor:"pointer",position:"relative",
                        background:isMoveTarget?"rgba(201,168,76,0.08)":"radial-gradient(ellipse at center,rgba(0,0,0,0.35) 0%,rgba(0,0,0,0.2) 70%,rgba(20,12,5,0.1) 100%)",
                        boxShadow:isMoveTarget?"inset 0 0 12px rgba(201,168,76,0.15)":"inset 0 3px 8px rgba(0,0,0,0.4),inset 0 -1px 2px rgba(0,0,0,0.2)",
                        border:isMoveTarget?"1px solid rgba(201,168,76,0.3)":"1px solid rgba(60,40,20,0.5)",
                        borderTop:"1px solid rgba(80,55,30,0.4)",borderBottom:"1px solid rgba(20,10,5,0.6)",
                        opacity:dim?0.15:isMoveSrc?0.4:1,
                        display:"flex",alignItems:"center",justifyContent:"center",
                        transition:"all 0.2s",animation:isMoveTarget?"pulseGlow 1.5s infinite":"none",
                      }}>
                      {b&&<div style={{width:CW-10,height:CH-8,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-end",animation:"bottlePlace 0.3s",position:"relative"}}>
                        <div style={{width:8,height:5,background:tc?.capC||"#5A0F1E",borderRadius:"2px 2px 0 0",boxShadow:"0 -1px 2px rgba(0,0,0,0.3)",flexShrink:0}}/>
                        <div style={{width:8,height:7,background:`linear-gradient(180deg,${color}CC,${color}88)`,flexShrink:0}}/>
                        <div style={{width:CW-14,height:CH-22,borderRadius:"4px 4px 3px 3px",
                          background:`linear-gradient(135deg,${color} 0%,${color}CC 40%,${color}88 100%)`,
                          boxShadow:`inset -4px 0 8px rgba(0,0,0,0.3),inset 2px 0 4px rgba(255,255,255,0.08),0 2px 6px rgba(0,0,0,0.4)`,
                          position:"relative",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                          <div style={{position:"absolute",top:0,left:"15%",width:"25%",height:"100%",
                            background:"linear-gradient(180deg,rgba(255,255,255,0.12),rgba(255,255,255,0.02),transparent)",borderRadius:2}}/>
                          <div style={{width:"80%",height:"55%",background:"rgba(255,250,240,0.85)",borderRadius:2,
                            display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 2px rgba(0,0,0,0.2)"}}>
                            <span style={{fontSize:7,fontWeight:800,color:"#2A1A0A",fontFamily:"'Playfair Display',serif",textAlign:"center",lineHeight:1,padding:"0 2px"}}>
                              {b.vintage?String(b.vintage).slice(2):"¬∑"}
                            </span>
                          </div>
                        </div>
                      </div>}
                      {!b&&!isMoveTarget&&<div style={{width:6,height:6,borderRadius:"50%",border:"1px dashed rgba(100,70,40,0.15)"}}/>}
                      {isMoveTarget&&<span style={{fontSize:14,opacity:0.5,color:P.gold}}>‚Üì</span>}
                    </div>})}
                </div>
                <div style={{marginLeft:24,height:6,
                  background:"linear-gradient(180deg,#5A4228 0%,#4A3420 40%,#3A2515 100%)",
                  borderRadius:"0 0 2px 2px",
                  boxShadow:"0 3px 6px rgba(0,0,0,0.4),inset 0 1px 0 rgba(200,160,100,0.12)",position:"relative"}}>
                  <div style={{position:"absolute",inset:0,opacity:0.08,
                    backgroundImage:"repeating-linear-gradient(90deg,transparent 0px,transparent 8px,rgba(255,200,100,0.3) 8px,rgba(255,200,100,0.3) 9px)"}}/>
                </div>
              </div>
            )}
          </div>
          <div style={{display:"flex",gap:14,justifyContent:"center",marginTop:14,flexWrap:"wrap"}}>
            {Object.entries(TP).map(([k,v])=>stats.types[k]?<div key={k} style={{display:"flex",alignItems:"center",gap:6,fontSize:11,color:P.ink3}}>
              <div style={{width:10,height:14,borderRadius:2,background:v.c,boxShadow:"inset -2px 0 3px rgba(0,0,0,0.3)"}}/>
              {v.l} ({stats.types[k]})
            </div>:null)}
          </div>
        </div>}
      </div>}

      {/* STATS */}
      {tab==="stats"&&<div style={{padding:"10px 20px 100px",animation:"fadeIn 0.2s"}}>
        <h2 className="serif" style={{fontSize:28,marginBottom:24,color:P.ink,fontWeight:400}}>Statistiques</h2>
        {stats.total===0?<div style={{textAlign:"center",padding:"60px 20px",color:P.ink4}}>Cave vide</div>:<>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:24}}>
            <Stat v={stats.total} l="Bouteilles" ic="üçæ"/>
            <Stat v={Math.round(stats.total/cap*100)+"%"} l="Remplie" ic="üìä"/>
            {stats.avgR&&<Stat v={stats.avgR} l="Note moy." ic="‚≠ê"/>}
            {stats.totV!=null&&<Stat v={Math.round(stats.totV)+"‚Ç¨"} l="Valeur" ic="üí∞"/>}
          </div>
          <Sec t="R√©partition">{Object.entries(TP).map(([k,v])=>{const n=stats.types[k]||0;if(!n)return null;const p=Math.round(n/stats.total*100);
            return<div key={k} style={{marginBottom:14}}>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}>
                <span style={{fontSize:14,display:"flex",alignItems:"center",gap:8}}><span>{v.ic}</span><span style={{fontWeight:500}}>{v.l}</span></span>
                <span style={{fontSize:13,color:P.ink3}}>{n} ¬∑ {p}%</span>
              </div>
              <div style={{height:4,background:P.bg3,borderRadius:2,overflow:"hidden"}}>
                <div style={{height:"100%",width:p+"%",background:`linear-gradient(90deg,${v.c},${v.c}88)`,borderRadius:2,transition:"width 0.8s"}}/>
              </div></div>})}</Sec>
          <Sec t="R√©gions">{Object.entries(stats.regions).sort((a,b)=>b[1]-a[1]).map(([r,n])=>
            <div key={r} style={{display:"flex",justifyContent:"space-between",padding:"10px 0",borderBottom:"1px solid "+P.bg3}}>
              <span style={{fontSize:14}}>{r}</span>
              <span style={{fontSize:12,fontWeight:700,color:P.gold,background:P.goldDim,padding:"3px 12px",borderRadius:10}}>{n}</span>
            </div>)}</Sec>
        </>}
      </div>}

      {/* SETTINGS */}
      {tab==="settings"&&<div style={{padding:"10px 20px 100px",animation:"fadeIn 0.2s"}}>
        <h2 className="serif" style={{fontSize:28,marginBottom:24,color:P.ink,fontWeight:400}}>R√©glages</h2>
        <Sec t="üìê Dimensions du casier">
          <div style={{display:"flex",gap:14,alignItems:"center"}}>
            <div style={{flex:1}}><label style={{fontSize:12,color:P.ink4,marginBottom:4,display:"block",fontWeight:600,letterSpacing:0.5,textTransform:"uppercase"}}>Colonnes</label>
              <input type="number" min={1} max={20} value={eCfg.cols} style={is} onChange={e=>setECfg(c=>({...c,cols:Math.max(1,Math.min(20,parseInt(e.target.value)||1))}))}/></div>
            <div style={{color:P.ink4,fontSize:18,paddingTop:20}}>√ó</div>
            <div style={{flex:1}}><label style={{fontSize:12,color:P.ink4,marginBottom:4,display:"block",fontWeight:600,letterSpacing:0.5,textTransform:"uppercase"}}>Rang√©es</label>
              <input type="number" min={1} max={20} value={eCfg.rows} style={is} onChange={e=>setECfg(c=>({...c,rows:Math.max(1,Math.min(20,parseInt(e.target.value)||1))}))}/></div>
          </div>
        </Sec>
        <Sec t="üîç Serveur de recherche">
          <input value={eCfg.backendUrl} style={is} onChange={e=>setECfg(c=>({...c,backendUrl:e.target.value}))} placeholder="https://ma-cave-api.xxx.workers.dev"/>
          {eCfg.backendUrl&&<button onClick={async()=>{try{const r=await fetch(eCfg.backendUrl+"/health",{signal:AbortSignal.timeout(15000)});if(r.ok){flash("‚úÖ Connect√© !");return}}catch{}flash("‚ùå Serveur inaccessible")}}
            style={{marginTop:10,padding:12,borderRadius:12,fontSize:14,fontWeight:500,background:P.bg3,color:P.ink2,width:"100%"}}>üîå Tester la connexion</button>}
        </Sec>
        <Sec t="üíæ Donn√©es">
          <div style={{display:"flex",gap:10}}>
            <button onClick={()=>{const d=JSON.stringify({bottles,config},null,2);const bl=new Blob([d],{type:"application/json"});const u=URL.createObjectURL(bl);const a=document.createElement("a");a.href=u;a.download="ma-cave-"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(u);flash("Export OK")}}
              style={{flex:1,padding:14,borderRadius:12,fontSize:14,fontWeight:500,background:P.bg3,color:P.ink2}}>üì§ Exporter</button>
            <button onClick={()=>{const i=document.createElement("input");i.type="file";i.accept=".json";i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.bottles)setBottles(d.bottles);if(d.config){setConfig(d.config);setECfg(d.config)}flash("Import OK")}catch{flash("Erreur")}};r.readAsText(f)};i.click()}}
              style={{flex:1,padding:14,borderRadius:12,fontSize:14,fontWeight:500,background:P.bg3,color:P.ink2}}>üì• Importer</button>
          </div>
        </Sec>
        <div style={{display:"flex",gap:10,marginTop:24}}>
          <button onClick={()=>{setConfig(eCfg);flash("Sauvegard√©");setTab("cave")}}
            style={{flex:1,padding:16,borderRadius:14,fontSize:15,fontWeight:600,background:`linear-gradient(135deg,${P.wine},#4A0A18)`,color:"#F0D8DC",boxShadow:"0 4px 20px rgba(123,32,56,0.3)",border:"1px solid rgba(255,200,200,0.08)"}}>üíæ Sauvegarder</button>
          <button onClick={()=>{if(confirm("Vider toute la cave ?")){setBottles({});flash("Cave vid√©e")}}}
            style={{padding:"16px 20px",borderRadius:14,fontSize:15,background:P.dangerBg,color:P.danger}}>üóë</button>
        </div>
      </div>}
    </main>

    {/* NAV */}
    <nav style={{position:"fixed",bottom:0,left:0,right:0,zIndex:50,background:"linear-gradient(180deg,transparent,#0C0A08 30%)",paddingTop:24,paddingBottom:"max(8px,env(safe-area-inset-bottom))"}}>
      <div style={{display:"flex",maxWidth:320,margin:"0 auto",background:P.bg2,borderRadius:20,padding:4,border:"1px solid "+P.bg3,boxShadow:"0 -4px 24px rgba(0,0,0,0.3)"}}>
        <NavBtn on={tab==="cave"} ic="üç∑" lb="Cave" ck={()=>setTab("cave")}/>
        <NavBtn on={tab==="stats"} ic="üìä" lb="Stats" ck={()=>setTab("stats")}/>
        <NavBtn on={tab==="settings"} ic="‚öôÔ∏è" lb="R√©glages" ck={()=>{setECfg(config);setTab("settings")}}/>
      </div>
    </nav>

    {/* ADD MODAL */}
    {modal?.type==="add"&&<Overlay cls={closeM}>
      <div style={{padding:"24px 20px 32px"}}>
        <MHead t="Ajouter" s={"Emplacement "+(parseInt(modal.cell.split("-")[0])+1)+String.fromCharCode(65+parseInt(modal.cell.split("-")[1]))} cls={closeM}/>
        {addMode!=="edit"&&<div style={{display:"flex",gap:6,marginBottom:18,background:P.bg2,borderRadius:12,padding:3}}>
          <TabBtn on={addMode==="vivino"} ck={()=>setAddMode("vivino")}>üîç Vivino</TabBtn>
          <TabBtn on={addMode==="manual"} ck={()=>{setAddMode("manual");setForm(ef())}}>‚úèÔ∏è Manuel</TabBtn>
        </div>}
        {addMode==="edit"&&<div style={{marginBottom:14}}>
          <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:12}}>
            <button onClick={()=>{setAddMode("vivino");setForm(ef())}} style={{fontSize:13,color:P.ink3}}>‚Üê Retour</button>
            <span style={{fontSize:14,color:P.gold,fontWeight:600}}>V√©rifiez & compl√©tez les infos</span>
          </div>
        </div>}
        {addMode==="vivino"&&<>
          <div style={{display:"flex",gap:8,marginBottom:14}}>
            <input value={query} onChange={e=>setQuery(e.target.value)} onKeyDown={e=>e.key==="Enter"&&runS()} placeholder="Ch√¢teau Margaux 2015..." style={{...is,flex:1}}/>
            <button onClick={runS} disabled={searching} style={{minWidth:52,borderRadius:12,background:`linear-gradient(135deg,${P.wine},#4A0A18)`,color:"#F0D8DC",fontSize:14,fontWeight:600,opacity:searching?0.5:1}}>{searching?"‚è≥":"‚Üí"}</button>
          </div>
          {searching&&<div style={{textAlign:"center",padding:30,color:P.ink3}}>
            <div style={{width:24,height:24,border:"2px solid "+P.bg3,borderTopColor:P.gold,borderRadius:"50%",animation:"spin 0.7s linear infinite",margin:"0 auto 14px"}}/>Recherche...</div>}
          {dbgLog.length>0&&!searching&&<div style={{marginBottom:12,padding:10,borderRadius:10,background:P.bg2,fontSize:11,color:P.ink3,fontFamily:"monospace",lineHeight:1.8,maxHeight:80,overflowY:"auto"}}>{dbgLog.map((l,i)=><div key={i}>{l}</div>)}</div>}
          {results.length>0&&<div style={{fontSize:12,marginBottom:10,color:P.ok,display:"flex",alignItems:"center",gap:6}}>
            <div style={{width:5,height:5,borderRadius:"50%",background:P.ok}}/>{results.length} r√©sultat{results.length>1?"s":""}
          </div>}
          {results.map((w,i)=><SrCard key={i} w={w} ck={()=>prefillFromVivino(w)} i={i}/>)}
        </>}
        {(addMode==="manual"||addMode==="edit")&&<FullForm f={form} sF={setForm} rg={fRegs} is={is}
          onSubmit={()=>{if(!form.name.trim())return;addB(modal.cell,formToBottle(form))}} btnLabel="Ajouter √† la cave" showVivino={addMode==="edit"}/>}
      </div>
    </Overlay>}

    {/* DETAIL MODAL */}
    {modal?.type==="detail"&&bottles[modal.cell]&&(()=>{const b=bottles[modal.cell],tc=TP[b.type]||TP.rouge;
      const atApo=b.apogee_start&&b.apogee_end&&yr>=b.apogee_start&&yr<=b.apogee_end;

      if(editMode){
        const init={name:b.name||"",winery:b.winery||"",vintage:b.vintage?String(b.vintage):"",type:b.type||"rouge",
          region:b.region||"Autre",notes:b.notes||"",image:b.image||"",
          apogee_start:b.apogee_start?String(b.apogee_start):"",apogee_end:b.apogee_end?String(b.apogee_end):"",
          rating:b.rating?String(b.rating):"",price:b.price||"",grape:b.grape||"",
          description:b.description||"",food:b.food||"",vivino_url:b.vivino_url||"",region_raw:b.region_raw||""};
        return<Overlay cls={closeM}>
          <div style={{padding:"24px 20px 32px"}}>
            <MHead t="Modifier" s={b.name?.substring(0,30)} cls={()=>setEditMode(false)}/>
            <EditForm init={init} rg={fRegs} is={is}
              onSave={(f)=>updateB(modal.cell,formToBottle(f))}
              onCancel={()=>setEditMode(false)}/>
          </div>
        </Overlay>}

      return<Overlay cls={closeM} noPad>
        <div style={{position:"relative",minHeight:b.image?300:160,background:`linear-gradient(180deg,${tc.bg} 0%,${P.bg1} 100%)`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}}>
          <div style={{position:"absolute",inset:0,background:"radial-gradient(circle at 50% 30%,"+tc.c+"15,transparent 70%)"}}/>
          {b.image?<img src={b.image} alt="" style={{maxHeight:280,maxWidth:"45%",objectFit:"contain",filter:"drop-shadow(0 16px 40px rgba(0,0,0,0.4))",position:"relative",zIndex:1}}/>
            :<div style={{fontSize:64,opacity:0.08}}>{tc.ic}</div>}
          <button onClick={closeM} style={{position:"absolute",top:16,right:16,width:36,height:36,borderRadius:12,background:"rgba(0,0,0,0.3)",backdropFilter:"blur(10px)",color:P.ink2,fontSize:16,display:"flex",alignItems:"center",justifyContent:"center",zIndex:2}}>‚úï</button>
        </div>
        <div style={{padding:"20px 22px 36px"}}>
          <div style={{display:"flex",gap:8,flexWrap:"wrap",marginBottom:14}}>
            <span style={{background:tc.bg,color:tc.c,padding:"4px 14px",borderRadius:10,fontSize:12,fontWeight:600}}>{tc.ic} {tc.l.toUpperCase()}</span>
            <span style={{background:P.goldDim,color:P.gold,padding:"4px 14px",borderRadius:10,fontSize:12,fontWeight:600}}>{b.region}</span>
            {atApo&&<span style={{background:P.okBg,color:P.ok,padding:"4px 14px",borderRadius:10,fontSize:12,fontWeight:600}}>üéØ APOG√âE</span>}
          </div>
          <h2 className="serif" style={{fontSize:24,fontWeight:400,lineHeight:1.25,marginBottom:4}}>{b.name}</h2>
          {b.winery&&<div style={{fontSize:14,color:P.ink3,marginBottom:6}}>{b.winery}</div>}
          {b.vintage&&<div className="serif" style={{fontSize:20,color:P.gold,marginBottom:18,fontStyle:"italic"}}>{b.vintage}</div>}
          {(b.rating||b.price)&&<div style={{display:"flex",gap:10,marginBottom:18}}>
            {b.rating&&<div style={{flex:1,background:P.goldDim,padding:16,borderRadius:14,textAlign:"center"}}>
              <div style={{fontSize:28,fontWeight:700,color:P.gold}}>‚òÖ {b.rating}</div>
              <div style={{fontSize:11,color:P.ink4,marginTop:4}}>Vivino</div>
            </div>}
            {b.price&&<div style={{flex:1,background:P.bg2,padding:16,borderRadius:14,textAlign:"center",border:"1px solid "+P.bg3}}>
              <div style={{fontSize:28,fontWeight:700}}>{b.price}</div>
              <div style={{fontSize:11,color:P.ink4,marginTop:4}}>Prix moyen</div>
            </div>}
          </div>}
          {b.grape&&<InfoRow l="C√âPAGES" v={b.grape}/>}
          {b.region_raw&&b.region_raw!==b.region&&<InfoRow l="APPELLATION" v={b.region_raw}/>}
          {(b.apogee_start||b.apogee_end)&&<InfoRow l="APOG√âE" v={(b.apogee_start||"?")+" ‚Äî "+(b.apogee_end||"?")} hl={atApo}/>}
          {b.description&&<InfoRow l="DESCRIPTION" v={b.description}/>}
          {b.food&&<InfoRow l="ACCORDS METS" v={b.food}/>}
          {b.body_desc&&<InfoRow l="CORPS" v={b.body_desc}/>}
          {b.acidity_desc&&<InfoRow l="ACIDIT√â" v={b.acidity_desc}/>}
          {b.notes&&<InfoRow l="MES NOTES" v={b.notes} accent/>}
          <div style={{display:"flex",gap:8,marginTop:22}}>
            <button onClick={()=>setEditMode(true)} style={{flex:1,padding:14,borderRadius:14,fontSize:14,fontWeight:500,background:P.goldDim,color:P.gold,border:"1px solid rgba(201,168,76,0.15)"}}>‚úèÔ∏è Modifier</button>
            <button onClick={()=>{setMoveMode(modal.cell);closeM()}} style={{flex:1,padding:14,borderRadius:14,fontSize:14,fontWeight:500,background:P.bg3,color:P.ink2}}>üì¶ D√©placer</button>
          </div>
          <div style={{display:"flex",gap:8,marginTop:8}}>
            {b.vivino_url&&<a href={b.vivino_url} target="_blank" rel="noopener" style={{flex:1,textAlign:"center",padding:14,borderRadius:14,fontSize:14,fontWeight:500,textDecoration:"none",background:P.bg3,color:P.ink2}}>üîó Vivino</a>}
            <button onClick={()=>{if(confirm("Retirer cette bouteille ?"))rmB(modal.cell)}} style={{padding:"14px 20px",borderRadius:14,fontSize:14,fontWeight:500,background:P.dangerBg,color:P.danger}}>üóë</button>
          </div>
        </div>
      </Overlay>})()}

    {toast&&<div style={{position:"fixed",bottom:90,left:"50%",transform:"translateX(-50%)",zIndex:200,background:P.gold,color:"#0C0A08",padding:"10px 28px",borderRadius:24,fontWeight:600,fontSize:14,animation:"scaleIn 0.15s",whiteSpace:"nowrap",boxShadow:"0 8px 24px rgba(201,168,76,0.3)"}}>{toast}</div>}
  </div>);
}

/* FULL FORM */
function FullForm({f,sF,rg,is,onSubmit,btnLabel,showVivino}){
  return<div style={{display:"flex",flexDirection:"column",gap:12}}>
    {showVivino&&f.image&&<div style={{display:"flex",gap:12,padding:12,borderRadius:14,background:"rgba(255,245,230,0.03)",border:"1px solid rgba(255,245,230,0.06)",marginBottom:4}}>
      <div style={{width:44,height:64,borderRadius:8,overflow:"hidden",flexShrink:0,background:"#1A1714"}}>
        <img src={f.image} alt="" style={{width:"100%",height:"100%",objectFit:"contain"}}/>
      </div>
      <div style={{flex:1,minWidth:0}}>
        <div style={{fontSize:14,fontWeight:600,color:"#EDE5D8",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{f.name}</div>
        <div style={{fontSize:12,color:"#8A8272"}}>{f.winery}{f.vintage?" ¬∑ "+f.vintage:""}</div>
        {f.rating&&<div style={{fontSize:12,color:"#C9A84C",marginTop:2}}>‚òÖ {f.rating}{f.price?" ¬∑ "+f.price:""}</div>}
      </div>
    </div>}
    <Fld l="Nom *"><input value={f.name} style={is} onChange={e=>sF(p=>({...p,name:e.target.value}))} placeholder="Ch√¢teau Margaux"/></Fld>
    <Fld l="Domaine"><input value={f.winery} style={is} onChange={e=>sF(p=>({...p,winery:e.target.value}))} placeholder="Domaine"/></Fld>
    <div style={{display:"flex",gap:10}}>
      <Fld l="Mill√©sime" s={{flex:1}}><input type="number" style={is} value={f.vintage} onChange={e=>sF(p=>({...p,vintage:e.target.value}))} placeholder="2020"/></Fld>
      <Fld l="Type" s={{flex:1}}><select value={f.type} style={{...is,appearance:"auto"}} onChange={e=>{const t=e.target.value;sF(p=>({...p,type:t,region:Object.keys(RC[t]||{})[0]||"Autre"}))}}>{Object.entries(TP).map(([k,v])=><option key={k} value={k}>{v.ic} {v.l}</option>)}</select></Fld>
    </div>
    <Fld l="R√©gion"><select value={rg.includes(f.region)?f.region:"_c"} style={{...is,appearance:"auto"}} onChange={e=>{if(e.target.value!=="_c")sF(p=>({...p,region:e.target.value}));else sF(p=>({...p,region:""}))}}>
      {rg.map(r=><option key={r} value={r}>{r}</option>)}<option value="_c">‚úèÔ∏è Saisir</option></select>
      {!rg.includes(f.region)&&<input value={f.region} style={{...is,marginTop:8}} onChange={e=>sF(p=>({...p,region:e.target.value}))} placeholder="Saisir..."/>}
    </Fld>
    <div style={{display:"flex",gap:10}}>
      <Fld l="Note /5" s={{flex:1}}><input type="number" step="0.1" min="0" max="5" style={is} value={f.rating} onChange={e=>sF(p=>({...p,rating:e.target.value}))} placeholder="4.2"/></Fld>
      <Fld l="Prix" s={{flex:1}}><input style={is} value={f.price} onChange={e=>sF(p=>({...p,price:e.target.value}))} placeholder="25‚Ç¨"/></Fld>
    </div>
    <div style={{display:"flex",gap:10}}>
      <Fld l="Apog√©e d√©but" s={{flex:1}}><input type="number" style={is} value={f.apogee_start} onChange={e=>sF(p=>({...p,apogee_start:e.target.value}))} placeholder="2025"/></Fld>
      <Fld l="Apog√©e fin" s={{flex:1}}><input type="number" style={is} value={f.apogee_end} onChange={e=>sF(p=>({...p,apogee_end:e.target.value}))} placeholder="2035"/></Fld>
    </div>
    <Fld l="C√©pages"><input style={is} value={f.grape} onChange={e=>sF(p=>({...p,grape:e.target.value}))} placeholder="Cabernet Sauvignon, Merlot"/></Fld>
    <Fld l="Accords mets"><input style={is} value={f.food} onChange={e=>sF(p=>({...p,food:e.target.value}))} placeholder="Agneau, fromage..."/></Fld>
    <Fld l="Description"><textarea rows={2} style={{...is,resize:"vertical"}} value={f.description} onChange={e=>sF(p=>({...p,description:e.target.value}))} placeholder="Nez de fruits noirs..."/></Fld>
    <Fld l="Mes notes"><textarea rows={2} style={{...is,resize:"vertical"}} value={f.notes} onChange={e=>sF(p=>({...p,notes:e.target.value}))} placeholder="Go√ªt, accords perso..."/></Fld>
    <button onClick={onSubmit} disabled={!f.name.trim()}
      style={{padding:16,borderRadius:14,fontSize:15,fontWeight:600,background:`linear-gradient(135deg,#7B2038,#4A0A18)`,color:"#F0D8DC",opacity:f.name.trim()?1:0.3,boxShadow:f.name.trim()?"0 4px 20px rgba(123,32,56,0.3)":"none",border:"1px solid rgba(255,200,200,0.08)",marginTop:4}}>{btnLabel||"Ajouter"}</button>
  </div>}

/* EDIT FORM */
function EditForm({init,rg,is,onSave,onCancel}){
  const[f,sF]=useState(init);
  return<div style={{display:"flex",flexDirection:"column",gap:12}}>
    <Fld l="Nom *"><input value={f.name} style={is} onChange={e=>sF(p=>({...p,name:e.target.value}))}/></Fld>
    <Fld l="Domaine"><input value={f.winery} style={is} onChange={e=>sF(p=>({...p,winery:e.target.value}))}/></Fld>
    <div style={{display:"flex",gap:10}}>
      <Fld l="Mill√©sime" s={{flex:1}}><input type="number" style={is} value={f.vintage} onChange={e=>sF(p=>({...p,vintage:e.target.value}))}/></Fld>
      <Fld l="Type" s={{flex:1}}><select value={f.type} style={{...is,appearance:"auto"}} onChange={e=>sF(p=>({...p,type:e.target.value}))}>{Object.entries(TP).map(([k,v])=><option key={k} value={k}>{v.ic} {v.l}</option>)}</select></Fld>
    </div>
    <Fld l="R√©gion"><select value={rg.includes(f.region)?f.region:"_c"} style={{...is,appearance:"auto"}} onChange={e=>{if(e.target.value!=="_c")sF(p=>({...p,region:e.target.value}));else sF(p=>({...p,region:""}))}}>
      {rg.map(r=><option key={r} value={r}>{r}</option>)}<option value="_c">‚úèÔ∏è Saisir</option></select>
      {!rg.includes(f.region)&&<input value={f.region} style={{...is,marginTop:8}} onChange={e=>sF(p=>({...p,region:e.target.value}))} placeholder="Saisir..."/>}
    </Fld>
    <div style={{display:"flex",gap:10}}>
      <Fld l="Note /5" s={{flex:1}}><input type="number" step="0.1" style={is} value={f.rating} onChange={e=>sF(p=>({...p,rating:e.target.value}))}/></Fld>
      <Fld l="Prix" s={{flex:1}}><input style={is} value={f.price} onChange={e=>sF(p=>({...p,price:e.target.value}))}/></Fld>
    </div>
    <div style={{display:"flex",gap:10}}>
      <Fld l="Apog√©e d√©but" s={{flex:1}}><input type="number" style={is} value={f.apogee_start} onChange={e=>sF(p=>({...p,apogee_start:e.target.value}))}/></Fld>
      <Fld l="Apog√©e fin" s={{flex:1}}><input type="number" style={is} value={f.apogee_end} onChange={e=>sF(p=>({...p,apogee_end:e.target.value}))}/></Fld>
    </div>
    <Fld l="C√©pages"><input style={is} value={f.grape} onChange={e=>sF(p=>({...p,grape:e.target.value}))}/></Fld>
    <Fld l="Accords mets"><input style={is} value={f.food} onChange={e=>sF(p=>({...p,food:e.target.value}))}/></Fld>
    <Fld l="Description"><textarea rows={2} style={{...is,resize:"vertical"}} value={f.description} onChange={e=>sF(p=>({...p,description:e.target.value}))}/></Fld>
    <Fld l="Mes notes"><textarea rows={2} style={{...is,resize:"vertical"}} value={f.notes} onChange={e=>sF(p=>({...p,notes:e.target.value}))}/></Fld>
    <div style={{display:"flex",gap:10}}>
      <button onClick={()=>onSave(f)} disabled={!f.name.trim()} style={{flex:1,padding:16,borderRadius:14,fontSize:15,fontWeight:600,background:`linear-gradient(135deg,#7B2038,#4A0A18)`,color:"#F0D8DC",opacity:f.name.trim()?1:0.3,border:"1px solid rgba(255,200,200,0.08)"}}>üíæ Enregistrer</button>
      <button onClick={onCancel} style={{padding:"16px 20px",borderRadius:14,fontSize:14,background:"rgba(255,245,230,0.04)",color:"#8A8272",border:"1px solid rgba(255,245,230,0.08)"}}>Annuler</button>
    </div>
  </div>}

/* SHARED COMPONENTS */
function Btn({ic,on,ck}){return<button onClick={ck} style={{width:38,height:34,borderRadius:10,background:on?"rgba(201,168,76,0.12)":"rgba(255,245,230,0.04)",color:on?P.gold:P.ink3,fontSize:15,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid "+(on?"rgba(201,168,76,0.15)":"rgba(255,245,230,0.06)")}}>{ic}</button>}
function Tag({on,ck,children,c}){return<button onClick={ck} style={{padding:"5px 12px",borderRadius:10,fontSize:11,fontWeight:600,fontFamily:"inherit",whiteSpace:"nowrap",letterSpacing:0.3,background:on?(c||P.wine)+"20":"rgba(255,245,230,0.04)",color:on?(c||P.gold):P.ink3,border:"1px solid "+(on?(c||P.wine)+"30":"transparent"),transition:"all 0.15s"}}>{children}</button>}
function NavBtn({on,ic,lb,ck}){return<button onClick={ck} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:2,padding:"10px 0 7px",borderRadius:16,background:on?"rgba(201,168,76,0.08)":"transparent",color:on?P.gold:P.ink4,fontSize:10,fontWeight:on?600:400,transition:"all 0.15s"}}><span style={{fontSize:17}}>{ic}</span>{lb}</button>}
function Overlay({children,cls,noPad}){return<div onClick={e=>{if(e.target===e.currentTarget)cls()}} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",backdropFilter:"blur(12px)",zIndex:100,display:"flex",alignItems:"flex-end",justifyContent:"center",animation:"fadeIn 0.1s"}}><div style={{width:"100%",maxWidth:480,maxHeight:"93vh",overflowY:"auto",background:P.bg1,borderRadius:"24px 24px 0 0",boxShadow:"0 -12px 48px rgba(0,0,0,0.4)",animation:"slideUp 0.25s cubic-bezier(0.22,1,0.36,1)",border:"1px solid rgba(255,245,230,0.04)",borderBottom:"none"}}>{children}</div></div>}
function MHead({t,s,cls}){return<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:18}}><div><h2 className="serif" style={{fontSize:24,fontWeight:400,color:P.ink}}>{t}</h2>{s&&<div style={{fontSize:12,color:P.ink4,marginTop:3}}>{s}</div>}</div><button onClick={cls} style={{width:34,height:34,borderRadius:10,background:P.bg3,color:P.ink3,fontSize:16,display:"flex",alignItems:"center",justifyContent:"center"}}>‚úï</button></div>}
function TabBtn({on,ck,children}){return<button onClick={ck} style={{flex:1,padding:10,borderRadius:10,fontSize:13,fontWeight:600,fontFamily:"inherit",background:on?"rgba(201,168,76,0.1)":"transparent",color:on?P.gold:P.ink4,transition:"all 0.15s"}}>{children}</button>}
function SrCard({w,ck,i}){const tc=TP[w.type]||TP.rouge;return<div onClick={ck} style={{display:"flex",gap:12,padding:12,borderRadius:14,cursor:"pointer",background:P.card,border:"1px solid "+P.cardB,marginBottom:8,animation:`fadeIn 0.2s ${i*0.05}s both`,transition:"background 0.15s"}}>
  <div style={{width:44,height:64,borderRadius:10,flexShrink:0,overflow:"hidden",background:w.image?P.bg2:tc.grad,display:"flex",alignItems:"center",justifyContent:"center"}}>
    {w.image?<img src={w.image} alt="" style={{width:"100%",height:"100%",objectFit:"contain"}}/>:<span style={{fontSize:18,opacity:0.5}}>{tc.ic}</span>}
  </div>
  <div style={{flex:1,minWidth:0}}>
    <div style={{fontSize:14,fontWeight:600,color:P.ink,marginBottom:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{w.name}</div>
    {w.winery&&<div style={{fontSize:11,color:P.ink4,marginBottom:3}}>{w.winery}</div>}
    <div style={{fontSize:11,color:P.ink3}}>{w.vintage&&w.vintage+" ¬∑ "}{w.region}</div>
    <div style={{display:"flex",gap:8,marginTop:3,fontSize:11,flexWrap:"wrap"}}>
      {w.rating&&<span style={{color:P.gold}}>‚òÖ {w.rating}</span>}
      {w.price&&<span style={{color:P.ink4}}>{w.price}</span>}
      {w.grape&&<span style={{color:P.ink4,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:120}}>{w.grape}</span>}
    </div>
  </div><div style={{color:P.gold,fontSize:20,alignSelf:"center",opacity:0.3}}>+</div></div>}
function Fld({l,children,s}){return<div style={s}><div style={{fontSize:11,color:P.ink4,marginBottom:5,fontWeight:600,letterSpacing:0.8,textTransform:"uppercase"}}>{l}</div>{children}</div>}
function InfoRow({l,v,accent,hl}){return<div style={{marginBottom:10,padding:"12px 16px",borderRadius:14,background:accent?P.goldDim:hl?P.okBg:P.bg2,border:"1px solid "+(accent?"rgba(201,168,76,0.08)":hl?"rgba(109,175,109,0.08)":P.bg3)}}>
  <div style={{fontSize:10,fontWeight:700,letterSpacing:1,marginBottom:4,color:accent?P.gold:hl?P.ok:P.ink4,textTransform:"uppercase"}}>{l}</div>
  <div style={{fontSize:14,color:P.ink2,lineHeight:1.5}}>{v}</div></div>}
function Stat({v,l,ic}){return<div style={{background:P.card,borderRadius:16,padding:"18px 14px",textAlign:"center",border:"1px solid "+P.cardB}}>
  <div style={{fontSize:12,marginBottom:6}}>{ic}</div>
  <div className="serif" style={{fontSize:26,fontWeight:400,color:P.gold}}>{v}</div>
  <div style={{fontSize:11,color:P.ink4,marginTop:4,letterSpacing:0.5,textTransform:"uppercase"}}>{l}</div></div>}
function Sec({t,children}){return<div style={{marginBottom:22}}>
  <h3 style={{fontSize:14,fontWeight:600,marginBottom:12,color:P.ink3,letterSpacing:0.5,textTransform:"uppercase"}}>{t}</h3>
  <div style={{background:P.card,borderRadius:18,padding:18,border:"1px solid "+P.cardB}}>{children}</div></div>}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
