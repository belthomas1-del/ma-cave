<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2C1810">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <title>Ma Cave</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html{height:100%}
    body{font-family:'Source Sans 3','Segoe UI',sans-serif;-webkit-tap-highlight-color:transparent;overflow-x:hidden;min-height:100dvh;font-size:15px;line-height:1.5}
    ::-webkit-scrollbar{width:4px}
    ::-webkit-scrollbar-thumb{border-radius:4px}
    h1,h2,h3{font-family:'Libre Baskerville',Georgia,serif}
    input,select,textarea{padding:12px 16px;border-radius:10px;font-family:inherit;font-size:15px;width:100%;outline:none;transition:border 0.2s}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px rgba(74,14,27,0.08)}
    select{appearance:auto}
    button{font-family:inherit;cursor:pointer;border:none}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes popIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
    .rack-cell{position:relative;cursor:pointer;transition:transform 0.1s}
    .rack-cell:active{transform:scale(0.95)}
  </style>
</head>
<body>
<div id="root"></div>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const{useState,useEffect,useMemo}=React;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COLOR_THEMES = {
  light: {
    name: "Clair",
    bg: "#FAF6F0", bg2: "#F3EDE4", bg3: "#E8DFD3",
    card: "#fff", cardBorder: "#E8DFD3",
    ink: "#1A0A0E", ink2: "#3D2027", ink3: "#6B5055", ink4: "#9A8488",
    headerBg: "linear-gradient(135deg,#2C1810,#4A1E15,#3A1510)", headerText: "#E8D5B5",
    navBg: "#fff", navBorder: "#E8DFD3",
    accent: "#4A0E1B", accentText: "#fff",
    gold: "#B8860B",
    danger: "#FDEDEC", dangerText: "#C0392B",
    success: "#E8F5E9", successText: "#2E7D32",
    warn: "#FFF8E1",
    inputBg: "#fff", inputBorder: "#E8DFD3",
    shadow: "0 2px 12px rgba(74,14,27,0.08)",
  },
  dark: {
    name: "Sombre",
    bg: "#1A1215", bg2: "#231A1E", bg3: "#2E2225",
    card: "rgba(255,255,255,0.05)", cardBorder: "rgba(255,255,255,0.08)",
    ink: "#F0E6DA", ink2: "#C8B8A8", ink3: "#8A7A70", ink4: "#5A4A44",
    headerBg: "linear-gradient(135deg,#1A0E08,#2A1510,#200E0A)", headerText: "#E8D5B5",
    navBg: "#1A1215", navBorder: "rgba(255,255,255,0.08)",
    accent: "#C6A355", accentText: "#1A0A0E",
    gold: "#D4A424",
    danger: "rgba(180,40,40,0.15)", dangerText: "#E8A0A0",
    success: "rgba(80,180,80,0.1)", successText: "#80C880",
    warn: "rgba(180,160,80,0.1)",
    inputBg: "rgba(255,255,255,0.06)", inputBorder: "rgba(255,255,255,0.1)",
    shadow: "0 2px 12px rgba(0,0,0,0.3)",
  }
};

const RACK_THEMES = {
  wood: {
    name: "ğŸªµ Casier bois",
    rackBg: "linear-gradient(180deg,#8B6B48 0%,#7A5C3A 3%,#6B4D2C 6%,#7A5C3A 50%,#6B4D2C 94%,#5A3F20 97%,#4A3518 100%)",
    rackShadow: "0 8px 32px rgba(50,25,10,0.25),inset 0 2px 0 rgba(255,200,130,0.15),inset 0 -2px 0 rgba(0,0,0,0.2)",
    cellBorder: (c,r,cols,rows) => ({
      borderRight:"2px solid rgba(80,50,25,0.5)",
      borderBottom:"3px solid rgba(60,35,15,0.6)",
      borderTop:r===0?"2px solid rgba(120,80,40,0.3)":"1px solid rgba(100,70,35,0.2)",
      borderLeft:c===0?"2px solid rgba(80,50,25,0.5)":"none",
    }),
    cellEmpty: "inset 0 3px 8px rgba(0,0,0,0.2),inset 0 -1px 0 rgba(255,200,130,0.08)",
    labelColor: "rgba(255,220,170,0.4)",
    grain: {opacity:0.12,bg:"repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(40,20,5,0.4) 3px,rgba(40,20,5,0.4) 4px,transparent 4px,transparent 8px)"},
  },
  metal: {
    name: "ğŸ”© Cage mÃ©tal",
    rackBg: "linear-gradient(180deg,#4A4A4A 0%,#3A3A3A 5%,#2E2E2E 50%,#3A3A3A 95%,#2A2A2A 100%)",
    rackShadow: "0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.08)",
    cellBorder: (c,r) => ({
      borderRight:"2px solid rgba(100,100,100,0.6)",
      borderBottom:"2px solid rgba(80,80,80,0.7)",
      borderTop:r===0?"2px solid rgba(120,120,120,0.4)":"1px solid rgba(90,90,90,0.3)",
      borderLeft:c===0?"2px solid rgba(100,100,100,0.6)":"none",
    }),
    cellEmpty: "inset 0 2px 6px rgba(0,0,0,0.3)",
    labelColor: "rgba(180,180,180,0.4)",
    grain: {opacity:0.06,bg:"repeating-linear-gradient(90deg,transparent,transparent 14px,rgba(200,200,200,0.15) 14px,rgba(200,200,200,0.15) 15px)"},
  },
  stone: {
    name: "ğŸ° Cave voÃ»tÃ©e",
    rackBg: "linear-gradient(180deg,#5A5045 0%,#4A4038 5%,#3E3530 50%,#4A4038 95%,#353028 100%)",
    rackShadow: "0 8px 32px rgba(30,20,15,0.4),inset 0 1px 0 rgba(200,180,150,0.08),inset 0 -3px 0 rgba(0,0,0,0.2)",
    cellBorder: (c,r) => ({
      borderRight:"2px solid rgba(70,60,50,0.6)",
      borderBottom:"3px solid rgba(50,40,30,0.7)",
      borderTop:r===0?"2px solid rgba(90,80,65,0.4)":"1px solid rgba(70,60,50,0.25)",
      borderLeft:c===0?"2px solid rgba(70,60,50,0.6)":"none",
    }),
    cellEmpty: "inset 0 4px 10px rgba(0,0,0,0.35),inset 0 -1px 0 rgba(200,180,150,0.05)",
    labelColor: "rgba(200,180,150,0.35)",
    grain: {opacity:0.15,bg:"url(\"data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='0.6' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E\")"},
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WINE CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TYPE_CFG={
  rouge:{label:"Rouge",icon:"ğŸ·",base:"#6B1D2A",light:"#F5E8EB",dark:"#3A1520"},
  blanc:{label:"Blanc",icon:"ğŸ¥‚",base:"#C4A830",light:"#FBF5E6",dark:"#2A2410"},
  rose:{label:"RosÃ©",icon:"ğŸŒ¸",base:"#D47A94",light:"#FCF0F3",dark:"#2A1520"},
  petillant:{label:"PÃ©tillant",icon:"âœ¨",base:"#D4AF37",light:"#FDF8E8",dark:"#2A2515"}
};
const REGION_COLORS={
  rouge:{"Bordeaux":"#4A0E1B","Bourgogne":"#6B1D35","RhÃ´ne":"#5C1A1A","Loire":"#8B3A3A","Languedoc":"#6E2828","Sud-Ouest":"#7A3535","Beaujolais":"#9B2845","Provence":"#7A3A3A","Corse":"#502020","Italie":"#6B2535","Espagne":"#5E1E2E","Autre":"#5A2525"},
  blanc:{"Alsace":"#B8860B","Bourgogne":"#A07A10","Loire":"#8B7020","Bordeaux":"#957A15","Champagne":"#AA8A05","Jura":"#887020","Savoie":"#9A8530","Provence":"#A89028","Italie":"#9A8015","Espagne":"#8A7510","Autre":"#907818"},
  rose:{"Provence":"#C06080","Loire":"#B87088","Languedoc":"#B06878","RhÃ´ne":"#A86070","Bordeaux":"#A05868","Corse":"#985868","Italie":"#C07888","Espagne":"#B06878","Autre":"#A86878"},
  petillant:{"Champagne":"#D4AF37","CrÃ©mant d'Alsace":"#C0A030","CrÃ©mant de Bourgogne":"#B09528","CrÃ©mant de Loire":"#A89030","Prosecco":"#C8A830","Cava":"#B09525","Autre":"#B8A030"}
};
function getColor(b){if(!b)return null;return(REGION_COLORS[b.type]||{})[b.region]||TYPE_CFG[b.type]?.base||"#6B1D2A";}
function lighten(hex,a){try{let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgb(${Math.min(255,r+a)},${Math.min(255,g+a)},${Math.min(255,b+a)})`;}catch{return hex;}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORAGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SK="cave-v6";
const load=()=>{try{return JSON.parse(localStorage.getItem(SK))||{};}catch{return{};}};
const save=(d)=>{try{localStorage.setItem(SK,JSON.stringify(d));}catch{}};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIVINO SEARCH â€” FIXED
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VIVINO_API="https://www.vivino.com/api/explore/explore";
function classifyType(id){return{1:"rouge",2:"blanc",3:"petillant",4:"rose",7:"rose"}[id]||"rouge";}
function mapRegion(name){
  if(!name)return"Autre";const r=name.toLowerCase();
  const m={"bordeaux":"Bordeaux","bourgogne":"Bourgogne","burgundy":"Bourgogne","rhÃ´ne":"RhÃ´ne","rhone":"RhÃ´ne","loire":"Loire","alsace":"Alsace","champagne":"Champagne","languedoc":"Languedoc","roussillon":"Languedoc","provence":"Provence","beaujolais":"Beaujolais","sud-ouest":"Sud-Ouest","south west":"Sud-Ouest","jura":"Jura","savoie":"Savoie","corse":"Corse","corsica":"Corse","toscana":"Italie","tuscany":"Italie","piemonte":"Italie","piedmont":"Italie","veneto":"Italie","sicilia":"Italie","rioja":"Espagne","ribera":"Espagne","priorat":"Espagne","castilla":"Espagne","navarra":"Espagne"};
  for(const[k,v]of Object.entries(m))if(r.includes(k))return v;
  return name.length>2?name:"Autre";
}
function parseVivino(data){
  const matches = data?.explore_vintage?.matches || [];
  return matches.slice(0,10).map(m=>{
    const v=m.vintage||{},w=v.wine||{},s=v.statistics||{};
    let img=v.image?.location;if(img&&!img.startsWith("http"))img="https:"+img;
    const region=w.region?.name||w.region?.country?.name||"";
    const grapes=(w.grapes||[]).map(g=>g.name).filter(Boolean);
    const price=m.price?.amount?`${m.price.amount.toFixed(0)}â‚¬`:null;
    return{name:w.name||"Inconnu",winery:w.winery?.name||"",vintage:v.year||null,
      type:classifyType(w.type_id),region:mapRegion(region),region_raw:region,
      rating:s.ratings_average?Math.round(s.ratings_average*10)/10:null,
      price,image:img,grape:grapes.join(", ")||null,description:w.description||null,
      vivino_url:w.seo_name?`https://www.vivino.com${w.seo_name}`:null,
      added:null,notes:null,apogee_start:null,apogee_end:null};
  }).filter(r=>r.name!=="Inconnu");
}

// Helper to extract JSON from various proxy response formats
function extractJSON(text) {
  // Direct JSON from Vivino
  try {
    const d = JSON.parse(text);
    // allorigins /get wrapper: {contents: "...", status: {...}}
    if (d.contents && typeof d.contents === "string") {
      return JSON.parse(d.contents);
    }
    // Direct Vivino response
    if (d.explore_vintage) return d;
    return d;
  } catch (e) {
    return null;
  }
}

async function tryProxy(proxyFn, vivinoUrl, timeout) {
  const url = proxyFn(vivinoUrl);
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeout);
  try {
    const resp = await fetch(url, {
      signal: ctrl.signal,
      headers: { "Accept": "application/json" }
    });
    clearTimeout(timer);
    if (!resp.ok) return { ok: false, error: `HTTP ${resp.status}` };
    const text = await resp.text();
    if (!text || text.length < 10) return { ok: false, error: "RÃ©ponse vide" };
    const data = extractJSON(text);
    if (!data) return { ok: false, error: "Pas du JSON valide" };
    const results = parseVivino(data);
    return { ok: true, results, raw: text.slice(0, 100) };
  } catch (e) {
    clearTimeout(timer);
    return { ok: false, error: e.name === "AbortError" ? "Timeout" : e.message };
  }
}

async function searchWine(query, backendUrl, onStatus, onDebug) {
  const vivinoUrl = `${VIVINO_API}?q=${encodeURIComponent(query)}&country_code=FR&currency_code=EUR&language=fr&page=1&price_range_min=0&price_range_max=500`;
  const log = onDebug || (() => {});

  const proxies = [
    { name: "allorigins/get", fn: u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`, timeout: 8000 },
    { name: "allorigins/raw", fn: u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`, timeout: 8000 },
    { name: "corsproxy.io", fn: u => `https://corsproxy.io/?${encodeURIComponent(u)}`, timeout: 8000 },
    { name: "codetabs", fn: u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`, timeout: 8000 },
  ];

  onStatus("proxy");
  for (const p of proxies) {
    log(`â³ ${p.name}...`);
    const r = await tryProxy(p.fn, vivinoUrl, p.timeout);
    if (r.ok && r.results.length > 0) {
      log(`âœ… ${p.name}: ${r.results.length} rÃ©sultats`);
      return { results: r.results, source: p.name };
    }
    log(`âŒ ${p.name}: ${r.error}`);
  }

  // Backend fallback
  if (backendUrl) {
    onStatus("backend");
    log(`â³ Backend: ${backendUrl}...`);
    try {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 15000);
      const r = await fetch(`${backendUrl}/search?q=${encodeURIComponent(query)}`, { signal: ctrl.signal });
      clearTimeout(t);
      if (r.ok) {
        const d = await r.json();
        if (d.results?.length) {
          log(`âœ… Backend: ${d.results.length} rÃ©sultats`);
          return { results: d.results, source: "backend" };
        }
      }
    } catch (e) {
      log(`âŒ Backend: ${e.message}`);
    }
  }

  return null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTLE COMPONENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function Bottle({bottle,cellW,cellH}){
  const color=getColor(bottle);
  const bH=cellH*0.52,bW=cellW*0.52,nW=cellW*0.16,nH=bH*0.48,capW=cellW*0.06;
  return(
    <div style={{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}}>
      <div style={{width:capW,height:nH*0.55,background:"linear-gradient(180deg,#C0B090,#A09070)",borderRadius:"1px 0 0 1px",flexShrink:0}}/>
      <div style={{width:nW,height:nH,background:`linear-gradient(180deg,${lighten(color,30)},${color})`,borderRadius:"2px 2px 1px 1px",flexShrink:0,position:"relative",boxShadow:"inset 0 -2px 4px rgba(0,0,0,0.25),inset 0 2px 3px rgba(255,255,255,0.12)"}}>
        <div style={{position:"absolute",top:"10%",left:"20%",width:"15%",height:"60%",background:"rgba(255,255,255,0.15)",borderRadius:1}}/>
      </div>
      <div style={{width:bW,height:bH,background:`linear-gradient(180deg,${lighten(color,15)},${color},${lighten(color,-15)})`,borderRadius:"3px 6px 6px 3px",flexShrink:0,position:"relative",boxShadow:"inset 0 -3px 6px rgba(0,0,0,0.3),inset 0 3px 4px rgba(255,255,255,0.12),0 2px 4px rgba(0,0,0,0.15)"}}>
        <div style={{position:"absolute",top:"10%",left:"10%",width:"15%",height:"65%",background:"linear-gradient(180deg,rgba(255,255,255,0.2),transparent)",borderRadius:2}}/>
        <div style={{position:"absolute",top:"20%",right:"10%",width:"55%",height:"55%",background:"rgba(255,250,240,0.15)",borderRadius:2,border:"0.5px solid rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center"}}>
          <span style={{fontSize:Math.max(8,cellW*0.13),fontWeight:800,color:"rgba(255,255,255,0.9)",textShadow:"0 1px 2px rgba(0,0,0,0.4)"}}>{bottle.vintage?String(bottle.vintage).slice(2):""}</span>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function App(){
  const saved=load();
  const[bottles,setBottles]=useState(saved.bottles||{});
  const[config,setConfig]=useState({cols:10,rows:6,backendUrl:"",colorTheme:"light",rackTheme:"wood",...(saved.config||{})});
  const[tab,setTab]=useState("rack");
  const[modal,setModal]=useState(null);
  const[query,setQuery]=useState("");
  const[results,setResults]=useState([]);
  const[searching,setSearching]=useState(false);
  const[searchStatus,setSearchStatus]=useState("");
  const[searchErr,setSearchErr]=useState("");
  const[searchDebug,setSearchDebug]=useState([]);
  const[manual,setManual]=useState(false);
  const[form,setForm]=useState(ef());
  const[editCfg,setEditCfg]=useState(config);
  const[toast,setToast]=useState(null);
  const[fType,setFType]=useState(null);
  const[fRegion,setFRegion]=useState(null);
  const[fSearch,setFSearch]=useState("");
  const[fApogee,setFApogee]=useState(false);
  const[showFilters,setShowFilters]=useState(false);

  useEffect(()=>{save({bottles,config});},[bottles,config]);

  // Theme
  const T = COLOR_THEMES[config.colorTheme] || COLOR_THEMES.light;
  const R = RACK_THEMES[config.rackTheme] || RACK_THEMES.wood;

  // Apply theme to body
  useEffect(() => {
    document.body.style.background = T.bg;
    document.body.style.color = T.ink;
    document.querySelector('::-webkit-scrollbar-thumb')
  }, [config.colorTheme]);

  function ef(){return{name:"",vintage:"",type:"rouge",region:"Bordeaux",notes:"",image:"",apogee_start:"",apogee_end:""};}
  const flash=(m)=>{setToast(m);setTimeout(()=>setToast(null),2200);};
  const ck=(c,r)=>`${c}-${r}`;
  const closeModal=()=>{setModal(null);setQuery("");setResults([]);setSearchErr("");setManual(false);setSearchStatus("");setForm(ef());setSearchDebug([]);};

  const doSearch=async()=>{
    if(!query.trim())return;
    setSearching(true);setSearchErr("");setResults([]);setSearchDebug([]);
    const debugLog = [];
    const r=await searchWine(query.trim(),config.backendUrl,setSearchStatus,(msg)=>{debugLog.push(msg);setSearchDebug([...debugLog]);});
    if(r){setResults(r.results);setSearchStatus(r.source);}
    else setSearchErr("Aucun rÃ©sultat. VÃ©rifiez votre connexion ou essayez la saisie manuelle.");
    setSearching(false);
  };

  const addBottle=(key,data)=>{setBottles(p=>({...p,[key]:{...data,added:data.added||new Date().toISOString()}}));flash("âœ“ "+data.name);closeModal();};
  const removeBottle=(key)=>{setBottles(p=>{const n={...p};delete n[key];return n;});flash("Bouteille retirÃ©e");closeModal();};

  const allBottles=Object.values(bottles);
  const capacity=config.cols*config.rows;
  const year=new Date().getFullYear();
  const caveRegions=useMemo(()=>[...new Set(allBottles.map(b=>b.region))].sort(),[bottles]);
  const formRegions=useMemo(()=>{const tr=Object.keys(REGION_COLORS[form.type]||{});return[...new Set([...tr,...caveRegions])].sort();},[form.type,caveRegions]);

  const stats=useMemo(()=>{
    const s={total:0,types:{},regions:{},vintages:{},ratings:[],prices:[]};
    allBottles.forEach(b=>{s.total++;s.types[b.type]=(s.types[b.type]||0)+1;s.regions[b.region]=(s.regions[b.region]||0)+1;
      if(b.vintage)s.vintages[b.vintage]=(s.vintages[b.vintage]||0)+1;
      if(b.rating)s.ratings.push(b.rating);if(b.price){const n=parseFloat(b.price);if(!isNaN(n))s.prices.push(n);}});
    s.avgRating=s.ratings.length?(s.ratings.reduce((a,b)=>a+b,0)/s.ratings.length).toFixed(1):null;
    s.totalValue=s.prices.length?s.prices.reduce((a,b)=>a+b,0):null;return s;
  },[bottles]);

  const isFiltered=fType||fRegion||fSearch||fApogee;
  const matchF=(b)=>{if(!b)return false;if(fType&&b.type!==fType)return false;if(fRegion&&b.region!==fRegion)return false;
    if(fSearch){const q=fSearch.toLowerCase();if(!b.name.toLowerCase().includes(q)&&!(b.winery||"").toLowerCase().includes(q)&&!(b.vintage+"").includes(q))return false;}
    if(fApogee){if(!b.apogee_start&&!b.apogee_end)return false;if(year<(b.apogee_start||0)||year>(b.apogee_end||9999))return false;}return true;};

  const cellW=52,cellH=44;

  // Style helpers that use theme
  const inputStyle = {background:T.inputBg,border:`1.5px solid ${T.inputBorder}`,color:T.ink};
  const cardStyle = {background:T.card,border:`1px solid ${T.cardBorder}`,borderRadius:14,padding:16,boxShadow:T.shadow};

  return(
    <div style={{minHeight:"100dvh",display:"flex",flexDirection:"column",background:T.bg,color:T.ink}}>

      {/* â•â•â• HEADER â•â•â• */}
      <header style={{background:T.headerBg,color:T.headerText,padding:"18px 20px 14px",position:"relative",overflow:"hidden"}}>
        <div style={{position:"absolute",inset:0,opacity:0.06,backgroundImage:"repeating-linear-gradient(90deg,transparent,transparent 30px,rgba(255,200,100,0.3) 30px,rgba(255,200,100,0.3) 31px)"}}/>
        <div style={{display:"flex",alignItems:"flex-end",justifyContent:"space-between",position:"relative"}}>
          <div>
            <h1 style={{fontSize:26,fontWeight:700,color:T.headerText,letterSpacing:0.5,lineHeight:1}}>Ma Cave</h1>
            <div style={{fontSize:12,color:"rgba(232,213,181,0.5)",marginTop:6}}>
              {stats.total} bouteille{stats.total>1?"s":""}{stats.total>0&&` Â· ${Math.round(stats.total/capacity*100)}%`}
            </div>
          </div>
          {tab==="rack"&&(
            <button onClick={()=>setShowFilters(f=>!f)} style={{padding:"8px 16px",borderRadius:22,fontSize:13,fontWeight:600,background:showFilters||isFiltered?"rgba(232,213,181,0.2)":"rgba(255,255,255,0.08)",color:T.headerText,border:"1px solid rgba(232,213,181,0.15)"}}>
              {isFiltered?"âš¡":"â˜°"} Filtres
            </button>
          )}
        </div>
      </header>

      {/* â•â•â• FILTERS â€” only on rack tab â•â•â• */}
      {showFilters&&tab==="rack"&&(
        <div style={{background:T.card,padding:"14px 16px 16px",borderBottom:`1px solid ${T.cardBorder}`,boxShadow:T.shadow,animation:"fadeIn 0.15s"}}>
          <input value={fSearch} onChange={e=>setFSearch(e.target.value)} placeholder="ğŸ” Rechercher un vin, domaine, millÃ©sime..." style={{...inputStyle,marginBottom:12,padding:"10px 14px",fontSize:14}}/>
          <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:10}}>
            <Chip T={T} active={!fType} onClick={()=>setFType(null)} label="Tous"/>
            {Object.entries(TYPE_CFG).map(([k,v])=><Chip T={T} key={k} active={fType===k} onClick={()=>setFType(f=>f===k?null:k)} label={v.icon+" "+v.label} color={v.base} count={stats.types[k]||0}/>)}
          </div>
          {caveRegions.length>0&&(<div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:10}}>
            <Chip T={T} active={!fRegion} onClick={()=>setFRegion(null)} label="Toutes rÃ©gions"/>
            {caveRegions.map(r=><Chip T={T} key={r} active={fRegion===r} onClick={()=>setFRegion(f=>f===r?null:r)} label={r} count={stats.regions[r]||0}/>)}
          </div>)}
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <Chip T={T} active={fApogee} onClick={()=>setFApogee(f=>!f)} label={"ğŸ¯ Ã€ boire "+year} color="#2E7D32"/>
            {isFiltered&&<button onClick={()=>{setFType(null);setFRegion(null);setFSearch("");setFApogee(false);}} style={{fontSize:12,color:T.ink4,background:"none",textDecoration:"underline",marginLeft:"auto"}}>Effacer</button>}
          </div>
        </div>
      )}

      {/* â•â•â• MAIN â•â•â• */}
      <main style={{flex:1,overflowY:"auto",paddingBottom:76}}>

        {/* RACK */}
        {tab==="rack"&&(
          <div style={{padding:"14px 8px"}}>
            <div style={{background:R.rackBg,borderRadius:12,padding:"6px 4px",boxShadow:R.rackShadow,overflowX:"auto",position:"relative"}}>
              {/* Grain overlay */}
              <div style={{position:"absolute",inset:0,borderRadius:12,opacity:R.grain.opacity,pointerEvents:"none",backgroundImage:R.grain.bg}}/>
              {/* Col labels */}
              <div style={{display:"flex",paddingLeft:26,marginBottom:2}}>
                {Array.from({length:config.cols},(_,c)=><div key={c} style={{width:cellW,minWidth:cellW,textAlign:"center",fontSize:10,color:R.labelColor,fontWeight:700}}>{c+1}</div>)}
              </div>
              {/* Rows */}
              {Array.from({length:config.rows},(_,r)=>
                <div key={r} style={{display:"flex",alignItems:"center",position:"relative"}}>
                  <div style={{width:24,textAlign:"center",fontSize:10,color:R.labelColor,fontWeight:700,flexShrink:0}}>{String.fromCharCode(65+r)}</div>
                  {Array.from({length:config.cols},(_,c)=>{
                    const key=ck(c,r),b=bottles[key];
                    const filtered=isFiltered&&b&&!matchF(b);
                    const emptyDim=isFiltered&&!b;
                    const borders=R.cellBorder(c,r,config.cols,config.rows);
                    return(
                      <div key={key} className="rack-cell"
                        onClick={()=>{setForm(ef());setModal({type:b?"detail":"add",cell:key});}}
                        style={{width:cellW,height:cellH,minWidth:cellW,...borders,
                          background:"linear-gradient(180deg,rgba(0,0,0,0.12),transparent 30%,transparent 70%,rgba(0,0,0,0.08))",
                          opacity:filtered?0.15:emptyDim?0.5:1,
                          boxShadow:b?"none":R.cellEmpty,
                          display:"flex",alignItems:"center",justifyContent:"center"}}>
                        {b?<Bottle bottle={b} cellW={cellW} cellH={cellH}/>:
                          <div style={{width:"40%",height:"40%",border:`1.5px dashed rgba(150,120,80,0.15)`,borderRadius:"50%"}}/>}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            {/* Legend */}
            <div style={{display:"flex",gap:12,justifyContent:"center",marginTop:14,flexWrap:"wrap"}}>
              {Object.entries(TYPE_CFG).map(([k,v])=>stats.types[k]?(
                <div key={k} style={{display:"flex",alignItems:"center",gap:5,fontSize:12,color:T.ink3}}>
                  <div style={{width:14,height:8,borderRadius:2,background:v.base}}/>{v.label} ({stats.types[k]})
                </div>
              ):null)}
            </div>
          </div>
        )}

        {/* STATS */}
        {tab==="stats"&&(
          <div style={{padding:"20px 16px",animation:"fadeIn 0.2s"}}>
            <h2 style={{fontSize:24,marginBottom:20,color:T.accent}}>Statistiques</h2>
            {stats.total===0?(
              <div style={{textAlign:"center",padding:"50px 20px",color:T.ink4}}>
                <div style={{fontSize:48,marginBottom:16}}>ğŸ‡</div>
                <div style={{fontSize:17,fontWeight:500}}>Cave vide</div>
              </div>
            ):<>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:24}}>
                <MC T={T} icon="ğŸ¾" value={stats.total} label="Bouteilles"/>
                <MC T={T} icon="ğŸ“Š" value={Math.round(stats.total/capacity*100)+"%"} label="Remplissage"/>
                {stats.avgRating&&<MC T={T} icon="â­" value={stats.avgRating} label="Note moyenne"/>}
                {stats.totalValue!=null&&<MC T={T} icon="ğŸ’°" value={Math.round(stats.totalValue)+"â‚¬"} label="Valeur estimÃ©e"/>}
              </div>
              <CS T={T} title="Par type">
                {Object.entries(TYPE_CFG).map(([k,v])=>{const n=stats.types[k]||0;if(!n)return null;const pct=Math.round(n/stats.total*100);
                  return(<div key={k} style={{display:"flex",alignItems:"center",gap:12,marginBottom:14}}>
                    <div style={{width:38,height:38,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:config.colorTheme==="dark"?v.dark:v.light,fontSize:18,flexShrink:0}}>{v.icon}</div>
                    <div style={{flex:1}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                      <span style={{fontSize:14,fontWeight:600}}>{v.label}</span><span style={{fontSize:13,color:T.ink3}}>{n} Â· {pct}%</span></div>
                      <div style={{height:8,background:T.bg2,borderRadius:4,overflow:"hidden"}}><div style={{height:"100%",width:pct+"%",background:v.base,borderRadius:4,transition:"width 0.6s"}}/></div>
                    </div></div>);})}</CS>
              <CS T={T} title="Par rÃ©gion">
                {Object.entries(stats.regions).sort((a,b)=>b[1]-a[1]).map(([r,n])=>(
                  <div key={r} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:`1px solid ${T.bg2}`}}>
                    <span style={{fontSize:14,color:T.ink2}}>{r}</span>
                    <div style={{background:T.accent,color:T.accentText,fontSize:12,fontWeight:700,padding:"2px 10px",borderRadius:12}}>{n}</div>
                  </div>
                ))}</CS>
              {Object.keys(stats.vintages).length>0&&(
                <CS T={T} title="Par millÃ©sime"><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                  {Object.entries(stats.vintages).sort((a,b)=>Number(b[0])-Number(a[0])).slice(0,15).map(([y,n])=>(
                    <div key={y} style={{background:T.bg2,padding:"6px 14px",borderRadius:20,fontSize:13,fontWeight:500,color:T.ink2}}>
                      {y} <span style={{fontWeight:700,color:T.accent}}>Ã—{n}</span></div>
                  ))}</div></CS>
              )}
              {allBottles.some(b=>b.apogee_start||b.apogee_end)&&(
                <CS T={T} title={"ğŸ¯ Ã€ dÃ©guster en "+year}>
                  {allBottles.filter(b=>{const s=b.apogee_start||0,e=b.apogee_end||9999;return year>=s&&year<=e;}).map((b,i)=>(
                    <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:`1px solid ${T.bg2}`}}>
                      <div><div style={{fontSize:14,fontWeight:600}}>{b.name}</div><div style={{fontSize:12,color:T.ink4}}>{b.vintage&&b.vintage+" Â· "}{b.region}</div></div>
                      <div style={{fontSize:12,fontWeight:600,color:T.successText,background:T.success,padding:"3px 10px",borderRadius:12}}>{b.apogee_start}â€“{b.apogee_end}</div>
                    </div>
                  ))}</CS>
              )}
            </>}
          </div>
        )}

        {/* SETTINGS */}
        {tab==="settings"&&(
          <div style={{padding:"20px 16px",animation:"fadeIn 0.2s"}}>
            <h2 style={{fontSize:24,marginBottom:20,color:T.accent}}>RÃ©glages</h2>

            {/* THEME */}
            <CS T={T} title="ğŸ¨ Apparence">
              <div style={{marginBottom:14}}>
                <div style={{fontSize:12,color:T.ink4,marginBottom:6,fontWeight:600}}>ThÃ¨me couleur</div>
                <div style={{display:"flex",gap:8}}>
                  {Object.entries(COLOR_THEMES).map(([k,v])=>
                    <button key={k} onClick={()=>{setEditCfg(c=>({...c,colorTheme:k}));setConfig(c=>({...c,colorTheme:k}));}}
                      style={{flex:1,padding:"12px 10px",borderRadius:10,fontSize:13,fontWeight:600,
                        background:config.colorTheme===k?T.accent:T.bg2,
                        color:config.colorTheme===k?T.accentText:T.ink3,
                        border:`1.5px solid ${config.colorTheme===k?T.accent:T.cardBorder}`}}>
                      {k==="light"?"â˜€ï¸":"ğŸŒ™"} {v.name}
                    </button>
                  )}
                </div>
              </div>
              <div>
                <div style={{fontSize:12,color:T.ink4,marginBottom:6,fontWeight:600}}>Style du rack</div>
                <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                  {Object.entries(RACK_THEMES).map(([k,v])=>
                    <button key={k} onClick={()=>{setEditCfg(c=>({...c,rackTheme:k}));setConfig(c=>({...c,rackTheme:k}));}}
                      style={{flex:1,minWidth:90,padding:"12px 10px",borderRadius:10,fontSize:12,fontWeight:600,
                        background:config.rackTheme===k?T.accent:T.bg2,
                        color:config.rackTheme===k?T.accentText:T.ink3,
                        border:`1.5px solid ${config.rackTheme===k?T.accent:T.cardBorder}`}}>
                      {v.name}
                    </button>
                  )}
                </div>
              </div>
            </CS>

            <CS T={T} title="Dimensions du rack">
              <div style={{display:"flex",gap:14,alignItems:"center"}}>
                <div style={{flex:1}}><label style={{fontSize:12,color:T.ink4,marginBottom:4,display:"block",fontWeight:600}}>Colonnes</label>
                  <input type="number" min={1} max={20} value={editCfg.cols} style={inputStyle} onChange={e=>setEditCfg(c=>({...c,cols:Math.max(1,Math.min(20,parseInt(e.target.value)||1))}))}/></div>
                <div style={{color:T.ink4,fontSize:22,paddingTop:18}}>Ã—</div>
                <div style={{flex:1}}><label style={{fontSize:12,color:T.ink4,marginBottom:4,display:"block",fontWeight:600}}>RangÃ©es</label>
                  <input type="number" min={1} max={20} value={editCfg.rows} style={inputStyle} onChange={e=>setEditCfg(c=>({...c,rows:Math.max(1,Math.min(20,parseInt(e.target.value)||1))}))}/></div>
              </div>
              <div style={{fontSize:13,color:T.ink4,marginTop:8}}>CapacitÃ© : <strong style={{color:T.ink2}}>{editCfg.cols*editCfg.rows}</strong> bouteilles</div>
            </CS>

            <CS T={T} title="Recherche Vivino">
              <input value={editCfg.backendUrl} style={inputStyle} onChange={e=>setEditCfg(c=>({...c,backendUrl:e.target.value}))} placeholder="https://ma-cave-api.onrender.com"/>
              <p style={{fontSize:12,color:T.ink4,marginTop:8,lineHeight:1.6}}>Recherche via proxy CORS direct. Ajoutez un backend Render comme secours.</p>
              <button onClick={async()=>{
                const log=[];
                const r=await searchWine("margaux","",()=>{},(msg)=>log.push(msg));
                flash(r?("âœ… Recherche OK via "+r.source):("âŒ Ã‰chec â€” "+log.join(" | ")));
              }} style={{marginTop:10,padding:"11px",borderRadius:10,fontSize:14,fontWeight:500,background:T.bg2,color:T.ink2,width:"100%"}}>
                ğŸ”Œ Tester la recherche Vivino
              </button>
            </CS>

            <CS T={T} title="DonnÃ©es">
              <div style={{display:"flex",gap:10}}>
                <BtnC T={T} v="light" s={{flex:1}} onClick={()=>{const d=JSON.stringify({bottles,config},null,2);const bl=new Blob([d],{type:"application/json"});const u=URL.createObjectURL(bl);const a=document.createElement("a");a.href=u;a.download="ma-cave-"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(u);flash("Export OK");}}>ğŸ“¤ Exporter</BtnC>
                <BtnC T={T} v="light" s={{flex:1}} onClick={()=>{const i=document.createElement("input");i.type="file";i.accept=".json";i.onchange=(e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);if(d.bottles)setBottles(d.bottles);if(d.config){setConfig(d.config);setEditCfg(d.config);}flash("Import OK !");}catch{flash("Fichier invalide");}};r.readAsText(f);};i.click();}}>ğŸ“¥ Importer</BtnC>
              </div>
            </CS>

            <div style={{display:"flex",gap:10,marginTop:20}}>
              <BtnC T={T} v="primary" s={{flex:1}} onClick={()=>{setConfig(editCfg);flash("SauvegardÃ© !");setTab("rack");}}>ğŸ’¾ Sauvegarder</BtnC>
              <BtnC T={T} v="danger" onClick={()=>{if(confirm("Vider toute la cave ?")){setBottles({});flash("Cave vidÃ©e");setTab("rack");}}}>ğŸ—‘</BtnC>
            </div>
          </div>
        )}
      </main>

      {/* â•â•â• NAV â•â•â• */}
      <nav style={{position:"fixed",bottom:0,left:0,right:0,zIndex:50,background:T.navBg,borderTop:`1px solid ${T.navBorder}`,display:"flex",paddingBottom:"max(6px,var(--safe-b))",boxShadow:"0 -2px 12px rgba(0,0,0,0.06)"}}>
        <TabBtn T={T} active={tab==="rack"} icon="âŠ" label="Cave" onClick={()=>setTab("rack")}/>
        <TabBtn T={T} active={tab==="stats"} icon="â—" label="Stats" onClick={()=>setTab("stats")}/>
        <TabBtn T={T} active={tab==="settings"} icon="âš™" label="RÃ©glages" onClick={()=>{setEditCfg(config);setTab("settings");}}/>
      </nav>

      {/* â•â•â• ADD MODAL â•â•â• */}
      {modal?.type==="add"&&(
        <Sheet T={T} onClose={closeModal}>
          <SH T={T} title="Ajouter une bouteille" sub={"Emplacement "+(parseInt(modal.cell.split("-")[0])+1)+String.fromCharCode(65+parseInt(modal.cell.split("-")[1]))} onClose={closeModal}/>
          <div style={{display:"flex",gap:8,marginBottom:16}}>
            <Tog T={T} active={!manual} onClick={()=>setManual(false)}>ğŸ” Vivino</Tog>
            <Tog T={T} active={manual} onClick={()=>setManual(true)}>âœï¸ Manuel</Tog>
          </div>
          {!manual&&<>
            <div style={{display:"flex",gap:8,marginBottom:12}}>
              <input value={query} onChange={e=>setQuery(e.target.value)} onKeyDown={e=>e.key==="Enter"&&doSearch()} placeholder="Ex: ChÃ¢teau Margaux 2015" style={{...inputStyle,flex:1,padding:"12px 14px",fontSize:14}}/>
              <BtnC T={T} v="primary" onClick={doSearch} disabled={searching} s={{minWidth:60,opacity:searching?0.6:1}}>{searching?"...":"OK"}</BtnC>
            </div>
            {searching&&<Loader T={T} status={searchStatus}/>}
            {/* Debug log */}
            {searchDebug.length>0&&(
              <div style={{marginBottom:10,padding:10,borderRadius:8,background:T.bg2,fontSize:11,color:T.ink3,lineHeight:1.6,fontFamily:"monospace",maxHeight:100,overflowY:"auto"}}>
                {searchDebug.map((l,i)=><div key={i}>{l}</div>)}
              </div>
            )}
            {searchErr&&<div style={{padding:12,borderRadius:10,fontSize:13,marginBottom:12,background:T.danger,color:T.dangerText,border:`1px solid ${T.dangerText}22`}}>{searchErr}</div>}
            {!searching&&results.length>0&&(<div style={{fontSize:12,marginBottom:10,display:"flex",alignItems:"center",gap:6,color:T.successText}}><span style={{width:6,height:6,borderRadius:"50%",background:"currentColor"}}/>{results.length} rÃ©sultat{results.length>1?"s":""} via {searchStatus}</div>)}
            {results.map((w,i)=><WC T={T} key={i} wine={w} onClick={()=>addBottle(modal.cell,w)}/>)}
          </>}
          {manual&&<MF T={T} form={form} setForm={setForm} regions={formRegions} onAdd={d=>addBottle(modal.cell,d)}/>}
        </Sheet>
      )}

      {/* â•â•â• DETAIL MODAL â•â•â• */}
      {modal?.type==="detail"&&bottles[modal.cell]&&(()=>{
        const b=bottles[modal.cell],color=getColor(b),tc=TYPE_CFG[b.type]||TYPE_CFG.rouge;
        const bgLight=config.colorTheme==="dark"?tc.dark:tc.light;
        return(
          <Sheet T={T} onClose={closeModal} noPad>
            <div style={{position:"relative",height:b.image?280:120,background:`linear-gradient(180deg,${bgLight},${T.bg})`,display:"flex",alignItems:"center",justifyContent:"center"}}>
              {b.image?<img src={b.image} alt="" style={{maxHeight:260,maxWidth:"55%",objectFit:"contain",filter:"drop-shadow(0 10px 30px rgba(0,0,0,0.15))"}}/>
                :<div style={{fontSize:60,opacity:0.15}}>{tc.icon}</div>}
              <button onClick={closeModal} style={{position:"absolute",top:14,right:14,width:36,height:36,borderRadius:"50%",background:T.card,backdropFilter:"blur(6px)",color:T.ink3,fontSize:18,display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
              <div style={{position:"absolute",top:14,left:14,background:T.card,backdropFilter:"blur(6px)",padding:"4px 12px",borderRadius:12,fontSize:12,color:T.ink3,fontWeight:600}}>ğŸ“ {parseInt(modal.cell.split("-")[0])+1}{String.fromCharCode(65+parseInt(modal.cell.split("-")[1]))}</div>
            </div>
            <div style={{padding:"16px 20px 28px"}}>
              <div style={{display:"inline-flex",alignItems:"center",gap:6,marginBottom:10,background:bgLight,padding:"5px 14px",borderRadius:20,fontSize:13,fontWeight:600,color:tc.base}}><div style={{width:9,height:9,borderRadius:"50%",background:color}}/>{tc.label} Â· {b.region}</div>
              <h2 style={{fontSize:22,fontWeight:700,lineHeight:1.25,marginBottom:3,color:T.ink}}>{b.name}</h2>
              {b.winery&&<div style={{fontSize:14,color:T.ink4,marginBottom:4}}>{b.winery}</div>}
              {b.vintage&&<div style={{fontSize:17,color:T.gold,fontWeight:600,marginBottom:16}}>MillÃ©sime {b.vintage}</div>}
              {(b.rating||b.price)&&(<div style={{display:"flex",gap:10,marginBottom:16}}>
                {b.rating&&<div style={{flex:1,background:T.warn,padding:"14px",borderRadius:12,textAlign:"center"}}><div style={{fontSize:24,fontWeight:700,color:T.gold}}>â˜… {b.rating}</div><div style={{fontSize:11,color:T.ink4,marginTop:2}}>Vivino</div></div>}
                {b.price&&<div style={{flex:1,background:T.bg2,padding:"14px",borderRadius:12,textAlign:"center"}}><div style={{fontSize:24,fontWeight:700,color:T.ink}}>{b.price}</div><div style={{fontSize:11,color:T.ink4,marginTop:2}}>Prix moyen</div></div>}
              </div>)}
              {b.grape&&<IB T={T} label="CÃ‰PAGE(S)" value={b.grape}/>}
              {b.region_raw&&b.region_raw!==b.region&&<IB T={T} label="APPELLATION" value={b.region_raw}/>}
              {(b.apogee_start||b.apogee_end)&&<IB T={T} label="APOGÃ‰E" value={(b.apogee_start||"?")+" â€“ "+(b.apogee_end||"?")} hl={year>=(b.apogee_start||0)&&year<=(b.apogee_end||9999)}/>}
              {b.description&&<IB T={T} label="DESCRIPTION" value={b.description}/>}
              {b.notes&&<IB T={T} label="MES NOTES" value={b.notes} ac/>}
              {b.added&&<div style={{fontSize:12,color:T.ink4,marginTop:14}}>AjoutÃ© le {new Date(b.added).toLocaleDateString("fr-FR")}</div>}
              <div style={{display:"flex",gap:8,marginTop:20}}>
                {b.vivino_url&&<a href={b.vivino_url} target="_blank" rel="noopener noreferrer" style={{flex:1,textAlign:"center",padding:"12px",borderRadius:10,fontSize:14,fontWeight:500,textDecoration:"none",background:T.bg2,color:T.ink2}}>ğŸ”— Vivino</a>}
                <button onClick={()=>{if(confirm("Retirer ?"))removeBottle(modal.cell);}} style={{padding:"12px 20px",borderRadius:10,fontSize:14,fontWeight:500,background:T.danger,color:T.dangerText}}>ğŸ—‘ Retirer</button>
              </div>
            </div>
          </Sheet>
        );})()}

      {toast&&<div style={{position:"fixed",bottom:80,left:"50%",transform:"translateX(-50%)",zIndex:200,background:T.accent,color:T.accentText,padding:"11px 26px",borderRadius:28,fontWeight:600,fontSize:14,animation:"popIn 0.2s",whiteSpace:"nowrap",boxShadow:"0 6px 24px rgba(0,0,0,0.25)"}}>{toast}</div>}
    </div>
  );
}

/* â•â•â• COMPONENTS â•â•â• */
function TabBtn({T,active,icon,label,onClick}){return<button onClick={onClick} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:2,padding:"10px 0 6px",background:"none",color:active?T.accent:T.ink4,fontSize:10,fontWeight:active?700:400}}><span style={{fontSize:20,lineHeight:1}}>{icon}</span>{label}</button>;}
function Chip({T,active,onClick,label,color,count}){const c=color||T.accent;return<button onClick={onClick} style={{padding:"5px 12px",borderRadius:20,fontSize:12,fontWeight:500,fontFamily:"inherit",whiteSpace:"nowrap",background:active?c:T.bg2,color:active?"#fff":T.ink3,border:"none"}}>{label}{count>0&&!active?" ("+count+")":""}</button>;}
function BtnC({T,v,children,s,...p}){const st={primary:{background:T.accent,color:T.accentText,padding:"13px 20px",borderRadius:12,fontSize:15,fontWeight:600},light:{background:T.bg2,color:T.ink2,padding:"13px 20px",borderRadius:12,fontSize:14,fontWeight:500},danger:{background:T.danger,color:T.dangerText,padding:"13px 20px",borderRadius:12,fontSize:15,fontWeight:600}};return<button style={{...st[v],...s}} {...p}>{children}</button>;}
function Sheet({T,children,onClose,noPad}){return(<div onClick={e=>{if(e.target===e.currentTarget)onClose();}} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(8px)",zIndex:100,display:"flex",alignItems:"flex-end",justifyContent:"center",animation:"fadeIn 0.15s"}}><div style={{width:"100%",maxWidth:500,maxHeight:"92vh",overflowY:"auto",background:T.bg,borderRadius:"22px 22px 0 0",padding:noPad?0:"20px 18px",boxShadow:"0 -8px 40px rgba(0,0,0,0.12)",animation:"slideUp 0.3s cubic-bezier(0.22,1,0.36,1)"}}>{children}</div></div>);}
function SH({T,title,sub,onClose}){return<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:18}}><div><h2 style={{fontSize:20,fontWeight:700,color:T.accent}}>{title}</h2>{sub&&<div style={{fontSize:12,color:T.ink4,marginTop:3}}>{sub}</div>}</div><button onClick={onClose} style={{width:36,height:36,borderRadius:"50%",background:T.bg2,color:T.ink3,fontSize:20,display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button></div>;}
function Tog({T,active,children,onClick}){return<button onClick={onClick} style={{flex:1,padding:"11px",borderRadius:10,fontSize:13,fontWeight:600,fontFamily:"inherit",background:active?T.accent:T.bg2,color:active?T.accentText:T.ink3}}>{children}</button>;}
function Loader({T,status}){return<div style={{textAlign:"center",padding:30,color:T.ink4}}><div style={{width:30,height:30,border:`3px solid ${T.bg3}`,borderTopColor:T.accent,borderRadius:"50%",animation:"spin 0.8s linear infinite",margin:"0 auto 14px"}}/><div style={{fontSize:14}}>{status==="proxy"?"Recherche Vivino...":"Serveur backup..."}</div></div>;}
function WC({T,wine:w,onClick}){const tc=TYPE_CFG[w.type]||TYPE_CFG.rouge;return<div onClick={onClick} style={{display:"flex",gap:12,padding:12,borderRadius:14,cursor:"pointer",background:T.card,border:`1px solid ${T.cardBorder}`,marginBottom:8,boxShadow:T.shadow}}>{w.image&&<img src={w.image} alt="" style={{width:44,height:66,objectFit:"contain",borderRadius:6,flexShrink:0,background:T.bg2}}/>}<div style={{flex:1,minWidth:0}}><div style={{fontSize:14,fontWeight:600,color:T.ink,marginBottom:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{w.name}</div>{w.winery&&<div style={{fontSize:12,color:T.ink4,marginBottom:3}}>{w.winery}</div>}<div style={{fontSize:12,color:T.ink3,display:"flex",gap:6,flexWrap:"wrap"}}>{w.vintage&&<span>{w.vintage}</span>}{w.region&&<span>Â· {w.region}</span>}<span>Â· {tc.icon} {tc.label}</span></div><div style={{display:"flex",gap:8,marginTop:5,fontSize:12}}>{w.rating&&<span style={{color:T.gold,fontWeight:600}}>â˜… {w.rating}</span>}{w.price&&<span style={{color:T.ink4}}>{w.price}</span>}</div></div><div style={{color:T.accent,fontSize:24,alignSelf:"center",fontWeight:300,opacity:0.5}}>+</div></div>;}

function MF({T,form,setForm,regions,onAdd}){
  const is={background:T.inputBg,border:`1.5px solid ${T.inputBorder}`,color:T.ink};
  return<div style={{display:"flex",flexDirection:"column",gap:12}}>
  <Fld T={T} l="Nom du vin *"><input value={form.name} style={is} onChange={e=>setForm(f=>({...f,name:e.target.value}))} placeholder="ChÃ¢teau Margaux"/></Fld>
  <div style={{display:"flex",gap:10}}>
    <Fld T={T} l="MillÃ©sime" s={{flex:1}}><input type="number" value={form.vintage} style={is} onChange={e=>setForm(f=>({...f,vintage:e.target.value}))} placeholder="2020"/></Fld>
    <Fld T={T} l="Type *" s={{flex:1}}><select value={form.type} style={is} onChange={e=>{const t=e.target.value;setForm(f=>({...f,type:t,region:Object.keys(REGION_COLORS[t]||{})[0]||"Autre"}));}}>{Object.entries(TYPE_CFG).map(([k,v])=><option key={k} value={k}>{v.icon} {v.label}</option>)}</select></Fld>
  </div>
  <Fld T={T} l="RÃ©gion"><div style={{display:"flex",gap:8}}>
    <select value={regions.includes(form.region)?form.region:"__custom"} style={{...is,flex:1}} onChange={e=>{if(e.target.value!=="__custom")setForm(f=>({...f,region:e.target.value}));else setForm(f=>({...f,region:""}));}}>
      {regions.map(r=><option key={r} value={r}>{r}</option>)}
      <option value="__custom">âœï¸ Saisir</option>
    </select>
    {!regions.includes(form.region)&&<input value={form.region} style={{...is,flex:1}} onChange={e=>setForm(f=>({...f,region:e.target.value}))} placeholder="Nouvelle rÃ©gion..."/>}
  </div></Fld>
  <div style={{display:"flex",gap:10}}>
    <Fld T={T} l="ApogÃ©e dÃ©but" s={{flex:1}}><input type="number" value={form.apogee_start} style={is} onChange={e=>setForm(f=>({...f,apogee_start:e.target.value}))} placeholder="2025"/></Fld>
    <Fld T={T} l="ApogÃ©e fin" s={{flex:1}}><input type="number" value={form.apogee_end} style={is} onChange={e=>setForm(f=>({...f,apogee_end:e.target.value}))} placeholder="2035"/></Fld>
  </div>
  <Fld T={T} l="URL image"><input value={form.image} style={is} onChange={e=>setForm(f=>({...f,image:e.target.value}))} placeholder="https://..."/></Fld>
  <Fld T={T} l="Notes perso"><textarea rows={2} style={{...is,resize:"vertical"}} value={form.notes} onChange={e=>setForm(f=>({...f,notes:e.target.value}))} placeholder="GoÃ»t, accord mets-vin..."/></Fld>
  <BtnC T={T} v="primary" disabled={!form.name.trim()} s={{marginTop:4,opacity:form.name.trim()?1:0.4}}
    onClick={()=>onAdd({name:form.name,vintage:form.vintage?Number(form.vintage):null,type:form.type,region:form.region||"Autre",image:form.image||null,notes:form.notes||null,rating:null,price:null,vivino_url:null,apogee_start:form.apogee_start?Number(form.apogee_start):null,apogee_end:form.apogee_end?Number(form.apogee_end):null,winery:"",grape:null,description:null,region_raw:form.region||"Autre"})}>
    Ajouter Ã  la cave</BtnC>
</div>;}
function Fld({T,l,children,s}){return<div style={s}><div style={{fontSize:12,color:T.ink4,marginBottom:5,fontWeight:600}}>{l}</div>{children}</div>;}
function IB({T,label,value,ac,hl}){return<div style={{marginBottom:10,padding:"10px 14px",borderRadius:10,background:ac?T.warn:hl?T.success:T.bg2,border:hl?`1px solid ${T.successText}33`:"none"}}><div style={{fontSize:10,fontWeight:700,letterSpacing:0.5,marginBottom:3,color:ac?T.gold:hl?T.successText:T.ink4}}>{label}</div><div style={{fontSize:13,color:T.ink2,lineHeight:1.5}}>{value}</div></div>;}
function MC({T,icon,value,label}){return<div style={{background:T.card,borderRadius:14,padding:"18px 14px",textAlign:"center",boxShadow:T.shadow,border:`1px solid ${T.cardBorder}`}}><div style={{fontSize:14,marginBottom:6}}>{icon}</div><div style={{fontSize:24,fontWeight:700,color:T.accent,fontFamily:"'Libre Baskerville',serif"}}>{value}</div><div style={{fontSize:11,color:T.ink4,marginTop:4}}>{label}</div></div>;}
function CS({T,title,children}){return<div style={{marginBottom:20}}><h3 style={{fontSize:16,fontWeight:700,marginBottom:12,color:T.ink2}}>{title}</h3><div style={{background:T.card,borderRadius:14,padding:"16px",boxShadow:T.shadow,border:`1px solid ${T.cardBorder}`}}>{children}</div></div>;}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
