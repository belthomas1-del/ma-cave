<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2C1810">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <title>Ma Cave</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html{height:100%}
    body{font-family:'Outfit',system-ui,sans-serif;-webkit-tap-highlight-color:transparent;overflow-x:hidden;min-height:100dvh;font-size:15px;line-height:1.5}
    h1,h2,h3{font-family:'Cormorant Garamond',Georgia,serif}
    input,select,textarea{padding:12px 16px;border-radius:10px;font-family:inherit;font-size:15px;width:100%;outline:none;transition:all 0.2s}
    select{appearance:auto}
    button{font-family:inherit;cursor:pointer;border:none}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes popIn{from{transform:scale(0.92);opacity:0}to{transform:scale(1);opacity:1}}
    .rack-cell:active{transform:scale(0.93);transition:transform 0.1s}
  </style>
</head>
<body>
<div id="root"></div>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const{useState,useEffect,useMemo,useCallback}=React;

/* ‚ïê‚ïê‚ïê THEMES ‚ïê‚ïê‚ïê */
const COLORS={
  light:{
    bg:"#F8F5F0",bg2:"#EFEBE4",bg3:"#E2DCD3",card:"#fff",cardB:"#E8E2D8",
    ink:"#1A0F0A",ink2:"#3D2D22",ink3:"#6B5A50",ink4:"#9A8A80",
    hdr:"linear-gradient(135deg,#2C1810 0%,#3E2518 50%,#2C1810 100%)",hdrT:"#EDD9C0",
    nav:"#fff",navB:"#E8E2D8",
    accent:"#6B1D2A",accentT:"#fff",
    gold:"#A67C00",goldBg:"#FFF8E8",
    dangerBg:"#FDEDEC",dangerT:"#C0392B",
    successBg:"#EDF7ED",successT:"#2E7D32",
    inputBg:"#fff",inputB:"#DDD6CC",
    shadow:"0 1px 8px rgba(30,15,5,0.07)",
  },
  dark:{
    bg:"#161012",bg2:"#201820",bg3:"#2C2228",card:"rgba(255,255,255,0.05)",cardB:"rgba(255,255,255,0.08)",
    ink:"#EDE4D8",ink2:"#C0B0A0",ink3:"#806C60",ink4:"#584840",
    hdr:"linear-gradient(135deg,#100A0D 0%,#1A1015 50%,#100A0D 100%)",hdrT:"#D4BC9A",
    nav:"#161012",navB:"rgba(255,255,255,0.06)",
    accent:"#D4A855",accentT:"#100A0D",
    gold:"#D4A855",goldBg:"rgba(212,168,85,0.1)",
    dangerBg:"rgba(180,40,40,0.12)",dangerT:"#E0A0A0",
    successBg:"rgba(60,160,60,0.1)",successT:"#80C880",
    inputBg:"rgba(255,255,255,0.06)",inputB:"rgba(255,255,255,0.1)",
    shadow:"0 2px 12px rgba(0,0,0,0.3)",
  }
};
const RACKS={
  wood:{name:"Casier bois",emoji:"ü™µ",
    bg:"linear-gradient(180deg,#7A6040 0%,#6B5030 8%,#5C4225 50%,#6B5030 92%,#4A3518 100%)",
    shadow:"0 6px 24px rgba(40,20,5,0.3)",
    cellBg:"rgba(0,0,0,0.15)",cellBorder:"rgba(90,60,30,0.6)",cellShadow:"inset 0 3px 8px rgba(0,0,0,0.25)",
    labelC:"rgba(220,190,140,0.35)",
    grain:"repeating-linear-gradient(0deg,transparent 0px,transparent 4px,rgba(30,15,5,0.12) 4px,rgba(30,15,5,0.12) 5px)"},
  metal:{name:"Cage m√©tal",emoji:"üî©",
    bg:"linear-gradient(180deg,#484848 0%,#383838 8%,#2C2C2C 50%,#383838 92%,#222 100%)",
    shadow:"0 6px 24px rgba(0,0,0,0.35)",
    cellBg:"rgba(0,0,0,0.2)",cellBorder:"rgba(90,90,90,0.5)",cellShadow:"inset 0 2px 6px rgba(0,0,0,0.3)",
    labelC:"rgba(180,180,180,0.35)",
    grain:"repeating-linear-gradient(90deg,transparent 0px,transparent 20px,rgba(150,150,150,0.06) 20px,rgba(150,150,150,0.06) 21px)"},
  stone:{name:"Cave vo√ªt√©e",emoji:"üè∞",
    bg:"linear-gradient(180deg,#554840 0%,#4A3E35 8%,#3E3530 50%,#4A3E35 92%,#332C25 100%)",
    shadow:"0 6px 24px rgba(20,10,5,0.4)",
    cellBg:"rgba(0,0,0,0.18)",cellBorder:"rgba(80,65,50,0.5)",cellShadow:"inset 0 4px 10px rgba(0,0,0,0.3)",
    labelC:"rgba(190,170,140,0.3)",
    grain:"none"},
};

/* ‚ïê‚ïê‚ïê WINE CONFIG ‚ïê‚ïê‚ïê */
const TYPES={
  rouge:{label:"Rouge",icon:"üç∑",color:"#6B1D2A",light:"#F5E8EB",dark:"#2A1218"},
  blanc:{label:"Blanc",icon:"ü•Ç",color:"#B8860B",light:"#FBF5E6",dark:"#2A2410"},
  rose:{label:"Ros√©",icon:"üå∏",color:"#C87088",light:"#FCF0F3",dark:"#2A1520"},
  petillant:{label:"P√©tillant",icon:"‚ú®",color:"#C8A030",light:"#FDF8E8",dark:"#2A2515"}
};
const REG_C={rouge:{"Bordeaux":"#4A0E1B","Bourgogne":"#6B1D35","Rh√¥ne":"#5C1A1A","Loire":"#8B3A3A","Languedoc":"#6E2828","Sud-Ouest":"#7A3535","Beaujolais":"#9B2845","Provence":"#7A3A3A","Corse":"#502020","Italie":"#6B2535","Espagne":"#5E1E2E","Autre":"#5A2525"},blanc:{"Alsace":"#B8860B","Bourgogne":"#A07A10","Loire":"#8B7020","Bordeaux":"#957A15","Champagne":"#AA8A05","Jura":"#887020","Savoie":"#9A8530","Provence":"#A89028","Italie":"#9A8015","Espagne":"#8A7510","Autre":"#907818"},rose:{"Provence":"#C06080","Loire":"#B87088","Languedoc":"#B06878","Rh√¥ne":"#A86070","Bordeaux":"#A05868","Italie":"#C07888","Espagne":"#B06878","Autre":"#A86878"},petillant:{"Champagne":"#D4AF37","Cr√©mant d'Alsace":"#C0A030","Cr√©mant de Bourgogne":"#B09528","Cr√©mant de Loire":"#A89030","Prosecco":"#C8A830","Cava":"#B09525","Autre":"#B8A030"}};
function bColor(b){return b?(REG_C[b.type]||{})[b.region]||TYPES[b.type]?.color||"#6B1D2A":null;}
function classify(id){return{1:"rouge",2:"blanc",3:"petillant",4:"rose",7:"rose"}[id]||"rouge";}
function mapReg(n){if(!n)return"Autre";const r=n.toLowerCase();const m={"bordeaux":"Bordeaux","bourgogne":"Bourgogne","burgundy":"Bourgogne","rh√¥ne":"Rh√¥ne","rhone":"Rh√¥ne","loire":"Loire","alsace":"Alsace","champagne":"Champagne","languedoc":"Languedoc","roussillon":"Languedoc","provence":"Provence","beaujolais":"Beaujolais","sud-ouest":"Sud-Ouest","south west":"Sud-Ouest","jura":"Jura","savoie":"Savoie","corse":"Corse","corsica":"Corse","toscana":"Italie","tuscany":"Italie","piemonte":"Italie","piedmont":"Italie","veneto":"Italie","sicilia":"Italie","rioja":"Espagne","ribera":"Espagne","priorat":"Espagne","castilla":"Espagne","navarra":"Espagne"};for(const[k,v]of Object.entries(m))if(r.includes(k))return v;return n.length>2?n:"Autre";}

/* ‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê */
const SK="cave-v7";
const load=()=>{try{return JSON.parse(localStorage.getItem(SK))||{};}catch{return{};}};
const save=(d)=>{try{localStorage.setItem(SK,JSON.stringify(d));}catch{}};

/* ‚ïê‚ïê‚ïê SEARCH ‚Äî BACKEND FIRST, PROXIES FALLBACK ‚ïê‚ïê‚ïê */
function parseVivinoRaw(data){
  return(data?.explore_vintage?.matches||[]).slice(0,10).map(m=>{
    const v=m.vintage||{},w=v.wine||{},s=v.statistics||{};
    let img=v.image?.location;if(img&&!img.startsWith("http"))img="https:"+img;
    const rg=w.region?.name||w.region?.country?.name||"";
    const grapes=(w.grapes||[]).map(g=>g.name).filter(Boolean);
    const price=m.price?.amount?`${m.price.amount.toFixed(0)}‚Ç¨`:null;
    const name=w.name||"";if(!name)return null;
    return{name,winery:w.winery?.name||"",vintage:v.year||null,type:classify(w.type_id),region:mapReg(rg),region_raw:rg,
      rating:s.ratings_average?Math.round(s.ratings_average*10)/10:null,price,image:img||null,
      grape:grapes.join(", ")||null,description:w.description||null,
      vivino_url:w.seo_name?`https://www.vivino.com${w.seo_name}`:null,
      added:null,notes:null,apogee_start:null,apogee_end:null};
  }).filter(Boolean);
}
function parseBackendResult(r){
  return{name:r.name,winery:r.winery||"",vintage:r.vintage||null,type:classify(r.type_id),
    region:mapReg(r.region),region_raw:r.region||"",rating:r.rating,price:r.price,image:r.image||null,
    grape:r.grape||null,description:r.description||null,
    vivino_url:r.seo_name?`https://www.vivino.com${r.seo_name}`:null,
    added:null,notes:null,apogee_start:null,apogee_end:null};
}

async function doSearch(query,backendUrl,onStatus,onLog){
  const log=onLog||(()=>{});

  // 1. Try backend FIRST (most reliable)
  if(backendUrl){
    onStatus("backend");log("‚òÅÔ∏è Serveur Render...");
    try{
      const c=new AbortController();const t=setTimeout(()=>c.abort(),15000);
      const r=await fetch(`${backendUrl}/search?q=${encodeURIComponent(query)}`,{signal:c.signal});
      clearTimeout(t);
      if(r.ok){
        const d=await r.json();
        if(d.results?.length){
          const parsed=d.results.map(parseBackendResult);
          log(`‚úÖ ${parsed.length} r√©sultats via serveur`);
          return{results:parsed,source:"serveur"};
        }
        log("‚ö†Ô∏è Serveur OK mais 0 r√©sultat");
      } else log(`‚ùå Serveur: HTTP ${r.status}`);
    }catch(e){log(`‚ùå Serveur: ${e.name==="AbortError"?"Timeout (premier d√©marrage? r√©essayez dans 30s)":e.message}`);}
  } else {
    log("‚ö†Ô∏è Aucun serveur configur√© ‚Äî allez dans R√©glages");
  }

  // 2. Try CORS proxies as fallback
  const vivinoUrl=`https://www.vivino.com/api/explore/explore?q=${encodeURIComponent(query)}&country_code=FR&currency_code=EUR&language=fr&page=1&price_range_min=0&price_range_max=500`;
  const proxies=[
    {n:"allorigins",fn:u=>`https://api.allorigins.win/get?url=${encodeURIComponent(u)}`},
    {n:"corsproxy",fn:u=>`https://corsproxy.io/?${encodeURIComponent(u)}`},
    {n:"codetabs",fn:u=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`},
  ];
  onStatus("proxy");
  for(const p of proxies){
    log(`‚è≥ Proxy ${p.n}...`);
    try{
      const c=new AbortController();const t=setTimeout(()=>c.abort(),10000);
      const r=await fetch(p.fn(vivinoUrl),{signal:c.signal,headers:{Accept:"application/json"}});
      clearTimeout(t);if(!r.ok){log(`‚ùå ${p.n}: HTTP ${r.status}`);continue;}
      const txt=await r.text();
      let data;try{const j=JSON.parse(txt);data=j.contents?JSON.parse(j.contents):j;}catch{log(`‚ùå ${p.n}: pas du JSON`);continue;}
      const res=parseVivinoRaw(data);
      if(res.length){log(`‚úÖ ${res.length} via ${p.n}`);return{results:res,source:p.n};}
      log(`‚ö†Ô∏è ${p.n}: 0 r√©sultat`);
    }catch(e){log(`‚ùå ${p.n}: ${e.name==="AbortError"?"Timeout":e.message}`);continue;}
  }
  return null;
}

/* ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê */
function App(){
  const saved=load();
  const[bottles,setBottles]=useState(saved.bottles||{});
  const[config,setConfig]=useState({cols:10,rows:6,backendUrl:"",colorTheme:"light",rackTheme:"wood",...(saved.config||{})});
  const[tab,setTab]=useState("rack");
  const[modal,setModal]=useState(null);
  const[query,setQuery]=useState("");
  const[results,setResults]=useState([]);
  const[searching,setSearching]=useState(false);
  const[searchStatus,setSearchStatus]=useState("");
  const[searchErr,setSearchErr]=useState("");
  const[debugLog,setDebugLog]=useState([]);
  const[manual,setManual]=useState(false);
  const[form,setForm]=useState(ef());
  const[editCfg,setEditCfg]=useState(config);
  const[toast,setToast]=useState(null);
  const[fType,setFType]=useState(null);
  const[fRegion,setFRegion]=useState(null);
  const[fSearch,setFSearch]=useState("");
  const[fApogee,setFApogee]=useState(false);
  const[showFilters,setShowFilters]=useState(false);

  useEffect(()=>{save({bottles,config});},[bottles,config]);
  useEffect(()=>{document.body.style.background=T.bg;document.body.style.color=T.ink;});

  const T=COLORS[config.colorTheme]||COLORS.light;
  const RK=RACKS[config.rackTheme]||RACKS.wood;

  function ef(){return{name:"",vintage:"",type:"rouge",region:"Bordeaux",notes:"",image:"",apogee_start:"",apogee_end:""};}
  const flash=(m)=>{setToast(m);setTimeout(()=>setToast(null),2500);};
  const ck=(c,r)=>`${c}-${r}`;
  const closeModal=()=>{setModal(null);setQuery("");setResults([]);setSearchErr("");setManual(false);setSearchStatus("");setForm(ef());setDebugLog([]);};

  const runSearch=async()=>{
    if(!query.trim())return;
    setSearching(true);setSearchErr("");setResults([]);const logs=[];
    const r=await doSearch(query.trim(),config.backendUrl,setSearchStatus,m=>{logs.push(m);setDebugLog([...logs]);});
    if(r){setResults(r.results);setSearchStatus(r.source);}
    else setSearchErr("Aucun r√©sultat. "+(!config.backendUrl?"Configurez votre serveur Render dans les r√©glages.":"R√©essayez ou passez en saisie manuelle."));
    setSearching(false);
  };

  const addBottle=(key,data)=>{setBottles(p=>({...p,[key]:{...data,added:data.added||new Date().toISOString()}}));flash("‚úì "+data.name);closeModal();};
  const removeBottle=(key)=>{setBottles(p=>{const n={...p};delete n[key];return n;});flash("Bouteille retir√©e");closeModal();};

  const allB=Object.values(bottles);
  const cap=config.cols*config.rows;
  const yr=new Date().getFullYear();
  const caveRegs=useMemo(()=>[...new Set(allB.map(b=>b.region))].sort(),[bottles]);
  const formRegs=useMemo(()=>[...new Set([...Object.keys(REG_C[form.type]||{}),...caveRegs])].sort(),[form.type,caveRegs]);

  const stats=useMemo(()=>{
    const s={total:0,types:{},regions:{},vintages:{},ratings:[],prices:[]};
    allB.forEach(b=>{s.total++;s.types[b.type]=(s.types[b.type]||0)+1;s.regions[b.region]=(s.regions[b.region]||0)+1;
      if(b.vintage)s.vintages[b.vintage]=(s.vintages[b.vintage]||0)+1;
      if(b.rating)s.ratings.push(b.rating);if(b.price){const n=parseFloat(b.price);if(!isNaN(n))s.prices.push(n);}});
    s.avgRating=s.ratings.length?(s.ratings.reduce((a,c)=>a+c,0)/s.ratings.length).toFixed(1):null;
    s.totalValue=s.prices.length?s.prices.reduce((a,c)=>a+c,0):null;return s;
  },[bottles]);

  const isF=fType||fRegion||fSearch||fApogee;
  const matchF=(b)=>{if(!b)return false;if(fType&&b.type!==fType)return false;if(fRegion&&b.region!==fRegion)return false;
    if(fSearch){const q=fSearch.toLowerCase();if(!b.name.toLowerCase().includes(q)&&!(b.winery||"").toLowerCase().includes(q)&&!(b.vintage+"").includes(q))return false;}
    if(fApogee){if(!b.apogee_start&&!b.apogee_end)return false;if(yr<(b.apogee_start||0)||yr>(b.apogee_end||9999))return false;}return true;};

  const CW=56,CH=52; // bigger cells for photos
  const is={background:T.inputBg,border:`1.5px solid ${T.inputB}`,color:T.ink};

  return(
    <div style={{minHeight:"100dvh",display:"flex",flexDirection:"column",background:T.bg,color:T.ink}}>

      {/* HEADER */}
      <header style={{background:T.hdr,color:T.hdrT,padding:"20px 20px 16px",position:"relative"}}>
        <div style={{display:"flex",alignItems:"flex-end",justifyContent:"space-between"}}>
          <div>
            <h1 style={{fontSize:28,fontWeight:700,color:T.hdrT,letterSpacing:0.5,lineHeight:1}}>Ma Cave</h1>
            <div style={{fontSize:12,color:"rgba(237,217,192,0.45)",marginTop:6,fontWeight:400}}>
              {stats.total} bouteille{stats.total>1?"s":""}{stats.total>0?` ¬∑ ${Math.round(stats.total/cap*100)}%`:" ¬∑ vide"}
            </div>
          </div>
          {tab==="rack"&&<button onClick={()=>setShowFilters(f=>!f)} style={{padding:"8px 16px",borderRadius:22,fontSize:13,fontWeight:600,background:showFilters||isF?"rgba(237,217,192,0.2)":"rgba(255,255,255,0.07)",color:T.hdrT,border:"1px solid rgba(237,217,192,0.12)"}}>
            {isF?"‚ö°":"‚ò∞"} Filtres
          </button>}
        </div>
      </header>

      {/* FILTERS (rack only) */}
      {showFilters&&tab==="rack"&&(
        <div style={{background:T.card,padding:"14px 16px",borderBottom:`1px solid ${T.cardB}`,boxShadow:T.shadow,animation:"fadeIn 0.15s"}}>
          <input value={fSearch} onChange={e=>setFSearch(e.target.value)} placeholder="üîç Rechercher..." style={{...is,marginBottom:10,padding:"10px 14px",fontSize:14}}/>
          <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}}>
            <Chip T={T} on={!fType} click={()=>setFType(null)} label="Tous"/>
            {Object.entries(TYPES).map(([k,v])=><Chip T={T} key={k} on={fType===k} click={()=>setFType(f=>f===k?null:k)} label={v.icon+" "+v.label} c={v.color} n={stats.types[k]}/>)}
          </div>
          {caveRegs.length>0&&<div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}}>
            <Chip T={T} on={!fRegion} click={()=>setFRegion(null)} label="Toutes r√©gions"/>
            {caveRegs.map(r=><Chip T={T} key={r} on={fRegion===r} click={()=>setFRegion(f=>f===r?null:r)} label={r} n={stats.regions[r]}/>)}
          </div>}
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            <Chip T={T} on={fApogee} click={()=>setFApogee(f=>!f)} label={"üéØ √Ä boire "+yr} c="#2E7D32"/>
            {isF&&<button onClick={()=>{setFType(null);setFRegion(null);setFSearch("");setFApogee(false);}} style={{fontSize:12,color:T.ink4,background:"none",textDecoration:"underline",marginLeft:"auto",border:"none"}}>Effacer</button>}
          </div>
        </div>
      )}

      <main style={{flex:1,overflowY:"auto",paddingBottom:76}}>
        {/* ‚ïê‚ïê‚ïê RACK ‚ïê‚ïê‚ïê */}
        {tab==="rack"&&(
          <div style={{padding:"14px 8px"}}>
            <div style={{background:RK.bg,borderRadius:14,padding:"8px 6px",boxShadow:RK.shadow,overflowX:"auto",position:"relative"}}>
              {/* Texture */}
              {RK.grain!=="none"&&<div style={{position:"absolute",inset:0,borderRadius:14,opacity:1,pointerEvents:"none",backgroundImage:RK.grain}}/>}
              {/* Col headers */}
              <div style={{display:"flex",paddingLeft:28,marginBottom:3,position:"relative"}}>
                {Array.from({length:config.cols},(_,c)=><div key={c} style={{width:CW,minWidth:CW,textAlign:"center",fontSize:10,color:RK.labelC,fontWeight:700}}>{c+1}</div>)}
              </div>
              {/* Rows */}
              {Array.from({length:config.rows},(_,r)=>
                <div key={r} style={{display:"flex",alignItems:"center",position:"relative"}}>
                  <div style={{width:26,textAlign:"center",fontSize:10,color:RK.labelC,fontWeight:700,flexShrink:0}}>{String.fromCharCode(65+r)}</div>
                  {Array.from({length:config.cols},(_,c)=>{
                    const key=ck(c,r),b=bottles[key],color=bColor(b);
                    const filt=isF&&b&&!matchF(b);
                    const eDim=isF&&!b;
                    return(
                      <div key={key} className="rack-cell"
                        onClick={()=>{setForm(ef());setModal({type:b?"detail":"add",cell:key});}}
                        style={{
                          width:CW,height:CH,minWidth:CW,cursor:"pointer",
                          border:`1px solid ${RK.cellBorder}`,
                          background:RK.cellBg,
                          boxShadow:RK.cellShadow,
                          opacity:filt?0.12:eDim?0.4:1,
                          display:"flex",alignItems:"center",justifyContent:"center",
                          position:"relative",overflow:"hidden",
                        }}>
                        {b?(
                          /* ‚ïê‚ïê‚ïê FILLED CELL: photo or colored tag ‚ïê‚ïê‚ïê */
                          b.image?(
                            <div style={{width:"100%",height:"100%",position:"relative"}}>
                              <img src={b.image} alt="" style={{width:"100%",height:"100%",objectFit:"cover",opacity:0.85}}
                                onError={e=>{e.target.style.display="none";e.target.nextSibling.style.display="flex";}}/>
                              <div style={{display:"none",width:"100%",height:"100%",alignItems:"center",justifyContent:"center",position:"absolute",inset:0,background:color}}>
                                <span style={{color:"#fff",fontSize:11,fontWeight:700}}>{b.vintage?String(b.vintage).slice(2):TYPES[b.type]?.icon}</span>
                              </div>
                              {/* Year overlay */}
                              <div style={{position:"absolute",bottom:1,right:2,background:"rgba(0,0,0,0.65)",color:"#fff",fontSize:9,fontWeight:700,padding:"1px 4px",borderRadius:3,lineHeight:1.2}}>
                                {b.vintage?String(b.vintage).slice(2):""}
                              </div>
                              {/* Type dot */}
                              <div style={{position:"absolute",top:2,left:2,width:8,height:8,borderRadius:"50%",background:color,border:"1px solid rgba(255,255,255,0.5)"}}/>
                            </div>
                          ):(
                            /* No image ‚Äî colored cell */
                            <div style={{width:"100%",height:"100%",background:`radial-gradient(ellipse at 40% 35%,${color}CC,${color}88)`,display:"flex",alignItems:"center",justifyContent:"center",position:"relative"}}>
                              <span style={{color:"rgba(255,255,255,0.9)",fontSize:12,fontWeight:800,textShadow:"0 1px 3px rgba(0,0,0,0.4)"}}>{b.vintage?String(b.vintage).slice(2):""}</span>
                              <div style={{position:"absolute",top:2,right:3,fontSize:8}}>{TYPES[b.type]?.icon}</div>
                            </div>
                          )
                        ):(
                          /* Empty cell */
                          <div style={{width:16,height:16,border:`1.5px dashed rgba(150,130,100,0.15)`,borderRadius:"50%"}}/>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            {/* Legend */}
            {stats.total>0&&<div style={{display:"flex",gap:12,justifyContent:"center",marginTop:12,flexWrap:"wrap"}}>
              {Object.entries(TYPES).map(([k,v])=>stats.types[k]?<div key={k} style={{display:"flex",alignItems:"center",gap:4,fontSize:12,color:T.ink3}}>
                <div style={{width:10,height:10,borderRadius:3,background:v.color}}/>{v.label} ({stats.types[k]})
              </div>:null)}
            </div>}
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê */}
        {tab==="stats"&&(
          <div style={{padding:"20px 16px",animation:"fadeIn 0.2s"}}>
            <h2 style={{fontSize:26,marginBottom:20,color:T.accent}}>Statistiques</h2>
            {stats.total===0?<div style={{textAlign:"center",padding:"50px 20px",color:T.ink4}}><div style={{fontSize:48,marginBottom:16}}>üçá</div><div style={{fontSize:16,fontWeight:500}}>Cave vide</div></div>:<>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:24}}>
                <MC T={T} i="üçæ" v={stats.total} l="Bouteilles"/>
                <MC T={T} i="üìä" v={Math.round(stats.total/cap*100)+"%"} l="Remplissage"/>
                {stats.avgRating&&<MC T={T} i="‚≠ê" v={stats.avgRating} l="Note moyenne"/>}
                {stats.totalValue!=null&&<MC T={T} i="üí∞" v={Math.round(stats.totalValue)+"‚Ç¨"} l="Valeur"/>}
              </div>
              <CrdS T={T} title="Par type">{Object.entries(TYPES).map(([k,v])=>{const n=stats.types[k]||0;if(!n)return null;const p=Math.round(n/stats.total*100);
                return<div key={k} style={{display:"flex",alignItems:"center",gap:12,marginBottom:14}}>
                  <div style={{width:36,height:36,borderRadius:"50%",background:config.colorTheme==="dark"?v.dark:v.light,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,flexShrink:0}}>{v.icon}</div>
                  <div style={{flex:1}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:14,fontWeight:600}}>{v.label}</span><span style={{fontSize:13,color:T.ink3}}>{n} ¬∑ {p}%</span></div>
                    <div style={{height:7,background:T.bg2,borderRadius:4,overflow:"hidden"}}><div style={{height:"100%",width:p+"%",background:v.color,borderRadius:4,transition:"width 0.6s"}}/></div></div></div>})}</CrdS>
              <CrdS T={T} title="Par r√©gion">{Object.entries(stats.regions).sort((a,b)=>b[1]-a[1]).map(([r,n])=>
                <div key={r} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:`1px solid ${T.bg2}`}}>
                  <span style={{fontSize:14,color:T.ink2}}>{r}</span>
                  <div style={{background:T.accent,color:T.accentT,fontSize:12,fontWeight:700,padding:"2px 10px",borderRadius:12}}>{n}</div></div>)}</CrdS>
              {Object.keys(stats.vintages).length>0&&<CrdS T={T} title="Par mill√©sime"><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                {Object.entries(stats.vintages).sort((a,b)=>Number(b[0])-Number(a[0])).slice(0,15).map(([y,n])=>
                  <div key={y} style={{background:T.bg2,padding:"5px 12px",borderRadius:18,fontSize:13,fontWeight:500,color:T.ink2}}>{y} <span style={{fontWeight:700,color:T.accent}}>√ó{n}</span></div>
                )}</div></CrdS>}
              {allB.some(b=>b.apogee_start||b.apogee_end)&&<CrdS T={T} title={"üéØ √Ä d√©guster en "+yr}>
                {allB.filter(b=>{const s=b.apogee_start||0,e=b.apogee_end||9999;return yr>=s&&yr<=e;}).map((b,i)=>
                  <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:`1px solid ${T.bg2}`}}>
                    <div><div style={{fontSize:14,fontWeight:600}}>{b.name}</div><div style={{fontSize:12,color:T.ink4}}>{b.vintage&&b.vintage+" ¬∑ "}{b.region}</div></div>
                    <div style={{fontSize:12,fontWeight:600,color:T.successT,background:T.successBg,padding:"3px 10px",borderRadius:12}}>{b.apogee_start}‚Äì{b.apogee_end}</div></div>)}</CrdS>}
            </>}
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê */}
        {tab==="settings"&&(
          <div style={{padding:"20px 16px",animation:"fadeIn 0.2s"}}>
            <h2 style={{fontSize:26,marginBottom:20,color:T.accent}}>R√©glages</h2>

            <CrdS T={T} title="üé® Apparence">
              <div style={{marginBottom:14}}>
                <div style={{fontSize:12,color:T.ink4,marginBottom:6,fontWeight:600}}>Couleurs</div>
                <div style={{display:"flex",gap:8}}>
                  {Object.entries(COLORS).map(([k,v])=><button key={k} onClick={()=>{const c={...config,colorTheme:k};setConfig(c);setEditCfg(c);}}
                    style={{flex:1,padding:"12px",borderRadius:10,fontSize:13,fontWeight:600,background:config.colorTheme===k?T.accent:T.bg2,color:config.colorTheme===k?T.accentT:T.ink3,border:`1.5px solid ${config.colorTheme===k?T.accent:T.cardB}`}}>
                    {k==="light"?"‚òÄÔ∏è Clair":"üåô Sombre"}</button>)}
                </div>
              </div>
              <div>
                <div style={{fontSize:12,color:T.ink4,marginBottom:6,fontWeight:600}}>Style du rack</div>
                <div style={{display:"flex",gap:8}}>
                  {Object.entries(RACKS).map(([k,v])=><button key={k} onClick={()=>{const c={...config,rackTheme:k};setConfig(c);setEditCfg(c);}}
                    style={{flex:1,padding:"12px 8px",borderRadius:10,fontSize:12,fontWeight:600,background:config.rackTheme===k?T.accent:T.bg2,color:config.rackTheme===k?T.accentT:T.ink3,border:`1.5px solid ${config.rackTheme===k?T.accent:T.cardB}`}}>
                    {v.emoji} {v.name}</button>)}
                </div>
              </div>
            </CrdS>

            <CrdS T={T} title="üìê Dimensions">
              <div style={{display:"flex",gap:14,alignItems:"center"}}>
                <div style={{flex:1}}><label style={{fontSize:12,color:T.ink4,marginBottom:4,display:"block",fontWeight:600}}>Colonnes</label>
                  <input type="number" min={1} max={20} value={editCfg.cols} style={is} onChange={e=>setEditCfg(c=>({...c,cols:Math.max(1,Math.min(20,parseInt(e.target.value)||1))}))}/></div>
                <div style={{color:T.ink4,fontSize:22,paddingTop:18}}>√ó</div>
                <div style={{flex:1}}><label style={{fontSize:12,color:T.ink4,marginBottom:4,display:"block",fontWeight:600}}>Rang√©es</label>
                  <input type="number" min={1} max={20} value={editCfg.rows} style={is} onChange={e=>setEditCfg(c=>({...c,rows:Math.max(1,Math.min(20,parseInt(e.target.value)||1))}))}/></div>
              </div>
              <div style={{fontSize:13,color:T.ink4,marginTop:8}}>Capacit√© : <strong style={{color:T.ink2}}>{editCfg.cols*editCfg.rows}</strong></div>
            </CrdS>

            <CrdS T={T} title="üîç Recherche Vivino">
              <input value={editCfg.backendUrl} style={is} onChange={e=>setEditCfg(c=>({...c,backendUrl:e.target.value}))} placeholder="https://votre-app.onrender.com"/>
              <div style={{marginTop:10,padding:14,borderRadius:10,background:T.bg2,fontSize:13,color:T.ink3,lineHeight:1.7}}>
                <strong style={{color:T.ink2}}>‚ö° Comment activer la recherche :</strong><br/>
                1. Allez sur <a href="https://render.com/deploy?repo=https://github.com/belthomas1-del/ma-cave" target="_blank" style={{color:T.accent,fontWeight:600}}>render.com/deploy</a><br/>
                2. Cliquez "Deploy" (gratuit)<br/>
                3. Copiez l'URL ici (ex: https://ma-cave-api.onrender.com)<br/>
                <span style={{fontSize:11,color:T.ink4}}>Premier appel ~30s (le serveur gratuit dort)</span>
              </div>
              {editCfg.backendUrl&&<button onClick={async()=>{
                try{const r=await fetch(editCfg.backendUrl+"/health",{signal:AbortSignal.timeout(15000)});
                  if(r.ok){flash("‚úÖ Serveur connect√© !");return;}}catch{}flash("‚ùå Serveur injoignable (attendez 30s si premier lancement)");
              }} style={{marginTop:10,padding:"11px",borderRadius:10,fontSize:14,fontWeight:500,background:T.bg2,color:T.ink2,width:"100%"}}>üîå Tester</button>}
            </CrdS>

            <CrdS T={T} title="üíæ Donn√©es">
              <div style={{display:"flex",gap:10}}>
                <Btn T={T} v="light" s={{flex:1}} onClick={()=>{const d=JSON.stringify({bottles,config},null,2);const bl=new Blob([d],{type:"application/json"});const u=URL.createObjectURL(bl);const a=document.createElement("a");a.href=u;a.download="ma-cave-"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(u);flash("Export OK");}}>üì§ Exporter</Btn>
                <Btn T={T} v="light" s={{flex:1}} onClick={()=>{const i=document.createElement("input");i.type="file";i.accept=".json";i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.bottles)setBottles(d.bottles);if(d.config){setConfig(d.config);setEditCfg(d.config);}flash("Import OK");}catch{flash("Fichier invalide");}};r.readAsText(f);};i.click();}}>üì• Importer</Btn>
              </div>
            </CrdS>

            <div style={{display:"flex",gap:10,marginTop:20}}>
              <Btn T={T} v="primary" s={{flex:1}} onClick={()=>{setConfig({...editCfg,colorTheme:config.colorTheme,rackTheme:config.rackTheme});flash("Sauvegard√© !");setTab("rack");}}>üíæ Sauvegarder</Btn>
              <Btn T={T} v="danger" onClick={()=>{if(confirm("Vider toute la cave ?")){setBottles({});flash("Cave vid√©e");setTab("rack");}}}>üóë</Btn>
            </div>
          </div>
        )}
      </main>

      {/* NAV */}
      <nav style={{position:"fixed",bottom:0,left:0,right:0,zIndex:50,background:T.nav,borderTop:`1px solid ${T.navB}`,display:"flex",paddingBottom:"max(6px,env(safe-area-inset-bottom,0px))",boxShadow:"0 -2px 12px rgba(0,0,0,0.06)"}}>
        <TabBtn T={T} on={tab==="rack"} icon="‚äû" label="Cave" click={()=>setTab("rack")}/>
        <TabBtn T={T} on={tab==="stats"} icon="‚óé" label="Stats" click={()=>setTab("stats")}/>
        <TabBtn T={T} on={tab==="settings"} icon="‚öô" label="R√©glages" click={()=>{setEditCfg(config);setTab("settings");}}/>
      </nav>

      {/* ADD MODAL */}
      {modal?.type==="add"&&<Sheet T={T} onClose={closeModal}>
        <SheetH T={T} title="Ajouter" sub={"Emplacement "+(parseInt(modal.cell.split("-")[0])+1)+String.fromCharCode(65+parseInt(modal.cell.split("-")[1]))} onClose={closeModal}/>
        <div style={{display:"flex",gap:8,marginBottom:16}}>
          <Tog T={T} on={!manual} click={()=>setManual(false)}>üîç Vivino</Tog>
          <Tog T={T} on={manual} click={()=>setManual(true)}>‚úèÔ∏è Manuel</Tog>
        </div>
        {!manual&&<>
          <div style={{display:"flex",gap:8,marginBottom:12}}>
            <input value={query} onChange={e=>setQuery(e.target.value)} onKeyDown={e=>e.key==="Enter"&&runSearch()} placeholder="Ch√¢teau Margaux 2015..." style={{...is,flex:1,padding:"12px 14px",fontSize:14}}/>
            <Btn T={T} v="primary" onClick={runSearch} disabled={searching} s={{minWidth:56,opacity:searching?0.5:1}}>{searching?"‚è≥":"OK"}</Btn>
          </div>
          {searching&&<div style={{textAlign:"center",padding:24,color:T.ink4}}><div style={{width:28,height:28,border:`3px solid ${T.bg3}`,borderTopColor:T.accent,borderRadius:"50%",animation:"spin 0.8s linear infinite",margin:"0 auto 12px"}}/>{searchStatus==="backend"?"Recherche via serveur...":"Proxy CORS..."}</div>}
          {debugLog.length>0&&<div style={{marginBottom:10,padding:10,borderRadius:8,background:T.bg2,fontSize:11,color:T.ink3,lineHeight:1.6,fontFamily:"monospace",maxHeight:90,overflowY:"auto"}}>{debugLog.map((l,i)=><div key={i}>{l}</div>)}</div>}
          {searchErr&&<div style={{padding:12,borderRadius:10,fontSize:13,marginBottom:12,background:T.dangerBg,color:T.dangerT}}>{searchErr}</div>}
          {!searching&&results.length>0&&<div style={{fontSize:12,marginBottom:10,color:T.successT,display:"flex",alignItems:"center",gap:6}}>
            <span style={{width:6,height:6,borderRadius:"50%",background:"currentColor"}}/>{results.length} r√©sultat{results.length>1?"s":""} via {searchStatus}
          </div>}
          {results.map((w,i)=><WineCard T={T} key={i} w={w} onClick={()=>addBottle(modal.cell,w)}/>)}
        </>}
        {manual&&<ManualForm T={T} form={form} setForm={setForm} regions={formRegs} is={is} onAdd={d=>addBottle(modal.cell,d)}/>}
      </Sheet>}

      {/* DETAIL MODAL */}
      {modal?.type==="detail"&&bottles[modal.cell]&&(()=>{
        const b=bottles[modal.cell],color=bColor(b),tc=TYPES[b.type]||TYPES.rouge;
        const bgL=config.colorTheme==="dark"?tc.dark:tc.light;
        return<Sheet T={T} onClose={closeModal} noPad>
          <div style={{position:"relative",height:b.image?280:120,background:`linear-gradient(180deg,${bgL},${T.bg})`,display:"flex",alignItems:"center",justifyContent:"center"}}>
            {b.image?<img src={b.image} alt="" style={{maxHeight:260,maxWidth:"55%",objectFit:"contain",filter:"drop-shadow(0 10px 30px rgba(0,0,0,0.15))"}}/>:<div style={{fontSize:56,opacity:0.12}}>{tc.icon}</div>}
            <button onClick={closeModal} style={{position:"absolute",top:14,right:14,width:36,height:36,borderRadius:"50%",background:T.card,backdropFilter:"blur(6px)",color:T.ink3,fontSize:18,display:"flex",alignItems:"center",justifyContent:"center",border:"none"}}>‚úï</button>
            <div style={{position:"absolute",top:14,left:14,background:T.card,backdropFilter:"blur(6px)",padding:"4px 12px",borderRadius:12,fontSize:12,color:T.ink3,fontWeight:600}}>üìç {parseInt(modal.cell.split("-")[0])+1}{String.fromCharCode(65+parseInt(modal.cell.split("-")[1]))}</div>
          </div>
          <div style={{padding:"16px 20px 28px"}}>
            <div style={{display:"inline-flex",alignItems:"center",gap:6,marginBottom:10,background:bgL,padding:"5px 14px",borderRadius:20,fontSize:13,fontWeight:600,color:tc.color}}><div style={{width:9,height:9,borderRadius:"50%",background:color}}/>{tc.label} ¬∑ {b.region}</div>
            <h2 style={{fontSize:22,fontWeight:700,lineHeight:1.25,marginBottom:3,color:T.ink}}>{b.name}</h2>
            {b.winery&&<div style={{fontSize:14,color:T.ink4,marginBottom:4}}>{b.winery}</div>}
            {b.vintage&&<div style={{fontSize:17,color:T.gold,fontWeight:600,marginBottom:16}}>Mill√©sime {b.vintage}</div>}
            {(b.rating||b.price)&&<div style={{display:"flex",gap:10,marginBottom:16}}>
              {b.rating&&<div style={{flex:1,background:T.goldBg,padding:14,borderRadius:12,textAlign:"center"}}><div style={{fontSize:24,fontWeight:700,color:T.gold}}>‚òÖ {b.rating}</div><div style={{fontSize:11,color:T.ink4,marginTop:2}}>Vivino</div></div>}
              {b.price&&<div style={{flex:1,background:T.bg2,padding:14,borderRadius:12,textAlign:"center"}}><div style={{fontSize:24,fontWeight:700,color:T.ink}}>{b.price}</div><div style={{fontSize:11,color:T.ink4,marginTop:2}}>Prix moyen</div></div>}
            </div>}
            {b.grape&&<InfoB T={T} l="C√âPAGE(S)" v={b.grape}/>}
            {b.region_raw&&b.region_raw!==b.region&&<InfoB T={T} l="APPELLATION" v={b.region_raw}/>}
            {(b.apogee_start||b.apogee_end)&&<InfoB T={T} l="APOG√âE" v={(b.apogee_start||"?")+" ‚Äì "+(b.apogee_end||"?")} hl={yr>=(b.apogee_start||0)&&yr<=(b.apogee_end||9999)}/>}
            {b.description&&<InfoB T={T} l="DESCRIPTION" v={b.description}/>}
            {b.notes&&<InfoB T={T} l="MES NOTES" v={b.notes} ac/>}
            {b.added&&<div style={{fontSize:12,color:T.ink4,marginTop:14}}>Ajout√© le {new Date(b.added).toLocaleDateString("fr-FR")}</div>}
            <div style={{display:"flex",gap:8,marginTop:20}}>
              {b.vivino_url&&<a href={b.vivino_url} target="_blank" rel="noopener noreferrer" style={{flex:1,textAlign:"center",padding:12,borderRadius:10,fontSize:14,fontWeight:500,textDecoration:"none",background:T.bg2,color:T.ink2}}>üîó Vivino</a>}
              <button onClick={()=>{if(confirm("Retirer ?"))removeBottle(modal.cell);}} style={{padding:"12px 20px",borderRadius:10,fontSize:14,fontWeight:500,background:T.dangerBg,color:T.dangerT,border:"none"}}>üóë Retirer</button>
            </div>
          </div>
        </Sheet>;})()}

      {toast&&<div style={{position:"fixed",bottom:80,left:"50%",transform:"translateX(-50%)",zIndex:200,background:T.accent,color:T.accentT,padding:"11px 26px",borderRadius:28,fontWeight:600,fontSize:14,animation:"popIn 0.2s",whiteSpace:"nowrap",boxShadow:"0 6px 24px rgba(0,0,0,0.25)"}}>{toast}</div>}
    </div>
  );
}

/* ‚ïê‚ïê‚ïê UI COMPONENTS ‚ïê‚ïê‚ïê */
function TabBtn({T,on,icon,label,click}){return<button onClick={click} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:2,padding:"10px 0 6px",background:"none",color:on?T.accent:T.ink4,fontSize:10,fontWeight:on?700:400,border:"none"}}><span style={{fontSize:20,lineHeight:1}}>{icon}</span>{label}</button>}
function Chip({T,on,click,label,c,n}){const cl=c||T.accent;return<button onClick={click} style={{padding:"5px 12px",borderRadius:20,fontSize:12,fontWeight:on?600:400,fontFamily:"inherit",whiteSpace:"nowrap",background:on?cl:T.bg2,color:on?"#fff":T.ink3,border:"none"}}>{label}{n>0&&!on?` (${n})`:""}</button>}
function Btn({T,v,children,s,...p}){const st={primary:{background:T.accent,color:T.accentT,padding:"13px 20px",borderRadius:12,fontSize:15,fontWeight:600},light:{background:T.bg2,color:T.ink2,padding:"13px 20px",borderRadius:12,fontSize:14,fontWeight:500},danger:{background:T.dangerBg,color:T.dangerT,padding:"13px 20px",borderRadius:12,fontSize:15,fontWeight:600}};return<button style={{...st[v],border:"none",...s}} {...p}>{children}</button>}
function Sheet({T,children,onClose,noPad}){return<div onClick={e=>{if(e.target===e.currentTarget)onClose();}} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",backdropFilter:"blur(8px)",zIndex:100,display:"flex",alignItems:"flex-end",justifyContent:"center",animation:"fadeIn 0.12s"}}><div style={{width:"100%",maxWidth:500,maxHeight:"92vh",overflowY:"auto",background:T.bg,borderRadius:"22px 22px 0 0",padding:noPad?0:"20px 18px",boxShadow:"0 -8px 40px rgba(0,0,0,0.12)",animation:"slideUp 0.25s cubic-bezier(0.22,1,0.36,1)"}}>{children}</div></div>}
function SheetH({T,title,sub,onClose}){return<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:18}}><div><h2 style={{fontSize:22,fontWeight:700,color:T.accent}}>{title}</h2>{sub&&<div style={{fontSize:12,color:T.ink4,marginTop:3}}>{sub}</div>}</div><button onClick={onClose} style={{width:36,height:36,borderRadius:"50%",background:T.bg2,color:T.ink3,fontSize:20,display:"flex",alignItems:"center",justifyContent:"center",border:"none"}}>‚úï</button></div>}
function Tog({T,on,children,click}){return<button onClick={click} style={{flex:1,padding:11,borderRadius:10,fontSize:13,fontWeight:600,fontFamily:"inherit",background:on?T.accent:T.bg2,color:on?T.accentT:T.ink3,border:"none"}}>{children}</button>}
function WineCard({T,w,onClick}){const tc=TYPES[w.type]||TYPES.rouge;return<div onClick={onClick} style={{display:"flex",gap:12,padding:12,borderRadius:14,cursor:"pointer",background:T.card,border:`1px solid ${T.cardB}`,marginBottom:8,boxShadow:T.shadow}}>
  {w.image&&<img src={w.image} alt="" style={{width:44,height:66,objectFit:"contain",borderRadius:6,flexShrink:0,background:T.bg2}}/>}
  <div style={{flex:1,minWidth:0}}>
    <div style={{fontSize:14,fontWeight:600,color:T.ink,marginBottom:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{w.name}</div>
    {w.winery&&<div style={{fontSize:12,color:T.ink4,marginBottom:3}}>{w.winery}</div>}
    <div style={{fontSize:12,color:T.ink3,display:"flex",gap:6,flexWrap:"wrap"}}>{w.vintage&&<span>{w.vintage}</span>}{w.region&&<span>¬∑ {w.region}</span>}<span>¬∑ {tc.icon}</span></div>
    <div style={{display:"flex",gap:8,marginTop:4,fontSize:12}}>{w.rating&&<span style={{color:T.gold,fontWeight:600}}>‚òÖ {w.rating}</span>}{w.price&&<span style={{color:T.ink4}}>{w.price}</span>}</div>
  </div><div style={{color:T.accent,fontSize:24,alignSelf:"center",fontWeight:300,opacity:0.5}}>+</div></div>}

function ManualForm({T,form,setForm,regions,is,onAdd}){return<div style={{display:"flex",flexDirection:"column",gap:12}}>
  <Fl T={T} l="Nom *"><input value={form.name} style={is} onChange={e=>setForm(f=>({...f,name:e.target.value}))} placeholder="Ch√¢teau Margaux"/></Fl>
  <div style={{display:"flex",gap:10}}>
    <Fl T={T} l="Mill√©sime" s={{flex:1}}><input type="number" style={is} value={form.vintage} onChange={e=>setForm(f=>({...f,vintage:e.target.value}))} placeholder="2020"/></Fl>
    <Fl T={T} l="Type" s={{flex:1}}><select value={form.type} style={is} onChange={e=>{const t=e.target.value;setForm(f=>({...f,type:t,region:Object.keys(REG_C[t]||{})[0]||"Autre"}));}}>{Object.entries(TYPES).map(([k,v])=><option key={k} value={k}>{v.icon} {v.label}</option>)}</select></Fl>
  </div>
  <Fl T={T} l="R√©gion"><div style={{display:"flex",gap:8}}>
    <select value={regions.includes(form.region)?form.region:"__c"} style={{...is,flex:1}} onChange={e=>{if(e.target.value!=="__c")setForm(f=>({...f,region:e.target.value}));else setForm(f=>({...f,region:""}));}}>
      {regions.map(r=><option key={r} value={r}>{r}</option>)}<option value="__c">‚úèÔ∏è Saisir</option></select>
    {!regions.includes(form.region)&&<input value={form.region} style={{...is,flex:1}} onChange={e=>setForm(f=>({...f,region:e.target.value}))} placeholder="Nouvelle..."/>}
  </div></Fl>
  <div style={{display:"flex",gap:10}}>
    <Fl T={T} l="Apog√©e d√©but" s={{flex:1}}><input type="number" style={is} value={form.apogee_start} onChange={e=>setForm(f=>({...f,apogee_start:e.target.value}))} placeholder="2025"/></Fl>
    <Fl T={T} l="Apog√©e fin" s={{flex:1}}><input type="number" style={is} value={form.apogee_end} onChange={e=>setForm(f=>({...f,apogee_end:e.target.value}))} placeholder="2035"/></Fl>
  </div>
  <Fl T={T} l="Image URL"><input style={is} value={form.image} onChange={e=>setForm(f=>({...f,image:e.target.value}))} placeholder="https://..."/></Fl>
  <Fl T={T} l="Notes"><textarea rows={2} style={{...is,resize:"vertical"}} value={form.notes} onChange={e=>setForm(f=>({...f,notes:e.target.value}))} placeholder="Go√ªt, accords..."/></Fl>
  <Btn T={T} v="primary" disabled={!form.name.trim()} s={{marginTop:4,opacity:form.name.trim()?1:0.4}}
    onClick={()=>onAdd({name:form.name,vintage:form.vintage?Number(form.vintage):null,type:form.type,region:form.region||"Autre",image:form.image||null,notes:form.notes||null,rating:null,price:null,vivino_url:null,apogee_start:form.apogee_start?Number(form.apogee_start):null,apogee_end:form.apogee_end?Number(form.apogee_end):null,winery:"",grape:null,description:null,region_raw:form.region||"Autre"})}>Ajouter</Btn>
</div>}
function Fl({T,l,children,s}){return<div style={s}><div style={{fontSize:12,color:T.ink4,marginBottom:5,fontWeight:600}}>{l}</div>{children}</div>}
function InfoB({T,l,v,ac,hl}){return<div style={{marginBottom:10,padding:"10px 14px",borderRadius:10,background:ac?T.goldBg:hl?T.successBg:T.bg2,border:hl?`1px solid ${T.successT}33`:"none"}}><div style={{fontSize:10,fontWeight:700,letterSpacing:0.5,marginBottom:3,color:ac?T.gold:hl?T.successT:T.ink4}}>{l}</div><div style={{fontSize:13,color:T.ink2,lineHeight:1.5}}>{v}</div></div>}
function MC({T,i,v,l}){return<div style={{background:T.card,borderRadius:14,padding:"18px 14px",textAlign:"center",boxShadow:T.shadow,border:`1px solid ${T.cardB}`}}><div style={{fontSize:14,marginBottom:6}}>{i}</div><div style={{fontSize:24,fontWeight:700,color:T.accent,fontFamily:"'Cormorant Garamond',serif"}}>{v}</div><div style={{fontSize:11,color:T.ink4,marginTop:4}}>{l}</div></div>}
function CrdS({T,title,children}){return<div style={{marginBottom:20}}><h3 style={{fontSize:16,fontWeight:700,marginBottom:12,color:T.ink2}}>{title}</h3><div style={{background:T.card,borderRadius:14,padding:16,boxShadow:T.shadow,border:`1px solid ${T.cardB}`}}>{children}</div></div>}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
